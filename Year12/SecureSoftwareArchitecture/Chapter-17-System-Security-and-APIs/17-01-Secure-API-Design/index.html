
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Comprehensive educational resource for NSW HSC Software Engineering syllabus">
      
      
      
        <link rel="canonical" href="https://eatham532.github.io/Software-Engineering-HSC-Textbook/Year12/SecureSoftwareArchitecture/Chapter-17-System-Security-and-APIs/17-01-Secure-API-Design/">
      
      
        <link rel="prev" href="../../Chapter-16-Input-Security-and-Data-Protection/16-02-Privacy-by-Design/quiz/">
      
      
        <link rel="next" href="quiz/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>17.1 Secure API Design - Software Engineering Textbook HSC</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/diagram-modal.css">
    
      <link rel="stylesheet" href="../../../../assets/quiz.css">
    
      <link rel="stylesheet" href="../../../../assets/common.css">
    
      <link rel="stylesheet" href="../../../../assets/diagram-fix.css">
    
      <link rel="stylesheet" href="../../../../assets/cross-reference.css">
    
      <link rel="stylesheet" href="../../../../assets/site-banner.css">
    
      <link rel="stylesheet" href="../../../../assets/code-runner.css">
    
      <link rel="stylesheet" href="../../../../assets/code-editor.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-58275RL1P9"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-58275RL1P9",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-58275RL1P9",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#171-secure-api-design" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
  
  
    
    
    
    <div class="site-banner site-banner--warning" data-banner data-banner-version="1" role="status" aria-live="polite">
      <div class="site-banner__inner">
        <span class="site-banner__icon" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            
              <path d="M12 9v4"/><path d="M12 17h.01"/><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0Z"/>
            
          </svg>
        </span>
        <p class="site-banner__text">
          This textbook is in <strong>beta</strong> – content is actively being refined.
          
            <a class="site-banner__link" href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/issues/new/choose" target="_blank" rel="noopener">Report issues or suggestions</a>
          
        </p>
        <button type="button" class="site-banner__close" aria-label="Dismiss banner" title="Dismiss" data-banner-dismiss>&times;</button>
      </div>
    </div>
    <script>
      (function(){
        var banner=document.querySelector('[data-banner]');
        if(!banner) return;
        var version=banner.getAttribute('data-banner-version')||'1';
        var KEY='site_banner_dismissed_v'+version;
        try{ if(localStorage.getItem(KEY)){ banner.remove(); return;} }catch(e){}
        var btn=banner.querySelector('[data-banner-dismiss]');
        if(btn){ btn.addEventListener('click',function(){
          banner.classList.add('is-hiding');
          setTimeout(function(){ banner && banner.remove(); },200);
          try{ localStorage.setItem(KEY,'1'); }catch(e){}
        }); }
      })();
    </script>
  
  
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Software Engineering Textbook HSC" class="md-header__button md-logo" aria-label="Software Engineering Textbook HSC" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Software Engineering Textbook HSC
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              17.1 Secure API Design
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Eatham532/Software-Engineering-HSC-Textbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    

    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../Year11/ProgrammingFundamentals/" class="md-tabs__link">
          
  
  
  Year 11

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../ProgrammingForTheWeb/" class="md-tabs__link">
          
  
  
  Year 12

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../code-editor/" class="md-tabs__link">
        
  
  
    
  
  Code Editor

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Software Engineering Textbook HSC" class="md-nav__button md-logo" aria-label="Software Engineering Textbook HSC" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Software Engineering Textbook HSC
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Eatham532/Software-Engineering-HSC-Textbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../../../Year11/ProgrammingFundamentals/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Year 11
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Year 12
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Year 12
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../ProgrammingForTheWeb/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Programming For The Web
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Secure Software Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Secure Software Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-14-Security-Foundations/14-01-The-Business-Case-for-Security/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 14 — Security Foundations
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-15-Core-Security-Principles/15-01-Security-Fundamentals-CIA-Triad-and-AAA/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 15 — Core Security Principles
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-16-Input-Security-and-Data-Protection/16-01-Input-Validation-and-Sanitization/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 16 — Input Security and Data Protection
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_5" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2_5" id="__nav_3_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Chapter 17 — System Security and APIs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2_5">
            <span class="md-nav__icon md-icon"></span>
            Chapter 17 — System Security and APIs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_5_1" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2_5_1" id="__nav_3_2_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    17.1 Secure API Design
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_2_5_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2_5_1">
            <span class="md-nav__icon md-icon"></span>
            17.1 Secure API Design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Content
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Content
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-it-matters" class="md-nav__link">
    <span class="md-ellipsis">
      Why It Matters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-security-principles-for-apis" class="md-nav__link">
    <span class="md-ellipsis">
      Core Security Principles for APIs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Security Principles for APIs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-defense-in-depth" class="md-nav__link">
    <span class="md-ellipsis">
      1. Defense in Depth
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-principle-of-least-privilege" class="md-nav__link">
    <span class="md-ellipsis">
      2. Principle of Least Privilege
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-fail-securely" class="md-nav__link">
    <span class="md-ellipsis">
      3. Fail Securely
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-security-by-design" class="md-nav__link">
    <span class="md-ellipsis">
      4. Security by Design
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-authentication-methods" class="md-nav__link">
    <span class="md-ellipsis">
      API Authentication Methods
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Authentication Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-authentication-vs-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding Authentication vs Authorization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-api-keys" class="md-nav__link">
    <span class="md-ellipsis">
      1. API Keys
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. API Keys">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-api-key-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Basic API Key Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-key-security-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      API Key Security Best Practices
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-json-web-tokens-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      2. JSON Web Tokens (JWT)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. JSON Web Tokens (JWT)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jwt-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      JWT Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-oauth-20-flow-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      3. OAuth 2.0 Flow Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rate-limiting-and-dos-protection" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting and DoS Protection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rate Limiting and DoS Protection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#token-bucket-algorithm-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Token Bucket Algorithm Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#secure-session-management" class="md-nav__link">
    <span class="md-ellipsis">
      Secure Session Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Secure Session Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#session-security-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Session Security Principles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprehensive-session-manager-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Comprehensive Session Manager Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cors-and-cross-origin-security" class="md-nav__link">
    <span class="md-ellipsis">
      CORS and Cross-Origin Security
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CORS and Cross-Origin Security">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-cors-security-model" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding CORS Security Model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprehensive-cors-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Comprehensive CORS Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-security-testing" class="md-nav__link">
    <span class="md-ellipsis">
      API Security Testing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Security Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#security-testing-methodology" class="md-nav__link">
    <span class="md-ellipsis">
      Security Testing Methodology
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automated-security-testing-framework" class="md-nav__link">
    <span class="md-ellipsis">
      Automated Security Testing Framework
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-a-complete-secure-rest-api" class="md-nav__link">
    <span class="md-ellipsis">
      Building a Complete Secure REST API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building a Complete Secure REST API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#secure-api-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Secure API Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-secure-api-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Complete Secure API Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-and-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Summary and Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary and Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#essential-security-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Essential Security Principles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Checklist
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Checklist">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-keys" class="md-nav__link">
    <span class="md-ellipsis">
      API Keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jwt-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      JWT Tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oauth-20" class="md-nav__link">
    <span class="md-ellipsis">
      OAuth 2.0
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-bucket-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      Token Bucket Algorithm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#progressive-penalties" class="md-nav__link">
    <span class="md-ellipsis">
      Progressive Penalties
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secure-session-ids" class="md-nav__link">
    <span class="md-ellipsis">
      Secure Session IDs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-features" class="md-nav__link">
    <span class="md-ellipsis">
      Security Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#origin-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Origin Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Security Patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automated-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Automated Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprehensive-coverage" class="md-nav__link">
    <span class="md-ellipsis">
      Comprehensive Coverage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-deployment-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Production Deployment Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-pitfalls-to-avoid" class="md-nav__link">
    <span class="md-ellipsis">
      Common Pitfalls to Avoid
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practice-questions-and-exercises" class="md-nav__link">
    <span class="md-ellipsis">
      Practice Questions and Exercises
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Practice Questions and Exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exercise-1-secure-registration-system" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 1: Secure Registration System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-2-api-rate-limiter" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 2: API Rate Limiter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-3-cors-security-manager" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 3: CORS Security Manager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-4-security-testing-suite" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 4: Security Testing Suite
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#case-study-e-commerce-api-security-breach" class="md-nav__link">
    <span class="md-ellipsis">
      Case Study: E-commerce API Security Breach
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Summary Checklist
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary Checklist">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authentication-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      Authentication &amp; Authorization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rate-limiting-dos-protection" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting &amp; DoS Protection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#input-validation-sanitization" class="md-nav__link">
    <span class="md-ellipsis">
      Input Validation &amp; Sanitization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session-management" class="md-nav__link">
    <span class="md-ellipsis">
      Session Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cors-cross-origin-security" class="md-nav__link">
    <span class="md-ellipsis">
      CORS &amp; Cross-Origin Security
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring &amp; Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-security" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment Security
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="quiz/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quiz
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../17-02-Secure-Execution-and-Resource-Management/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    17.2 Secure Execution & Resource Management
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-18-Security-Testing-and-Vulnerabilities/18-01-Security-Testing-Fundamentals/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 18 — Security Testing & Vulnerabilities
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-19-Security-in-Context/19-01-Security-in-Development-Teams/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 19 — Security in Context
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../SoftwareAutomation/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Software Automation
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../SoftwareEngineeringProject/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Software Engineering Project
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../code-editor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code Editor
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-it-matters" class="md-nav__link">
    <span class="md-ellipsis">
      Why It Matters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-security-principles-for-apis" class="md-nav__link">
    <span class="md-ellipsis">
      Core Security Principles for APIs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Security Principles for APIs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-defense-in-depth" class="md-nav__link">
    <span class="md-ellipsis">
      1. Defense in Depth
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-principle-of-least-privilege" class="md-nav__link">
    <span class="md-ellipsis">
      2. Principle of Least Privilege
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-fail-securely" class="md-nav__link">
    <span class="md-ellipsis">
      3. Fail Securely
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-security-by-design" class="md-nav__link">
    <span class="md-ellipsis">
      4. Security by Design
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-authentication-methods" class="md-nav__link">
    <span class="md-ellipsis">
      API Authentication Methods
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Authentication Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-authentication-vs-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding Authentication vs Authorization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-api-keys" class="md-nav__link">
    <span class="md-ellipsis">
      1. API Keys
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. API Keys">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-api-key-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Basic API Key Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-key-security-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      API Key Security Best Practices
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-json-web-tokens-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      2. JSON Web Tokens (JWT)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. JSON Web Tokens (JWT)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jwt-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      JWT Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-oauth-20-flow-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      3. OAuth 2.0 Flow Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rate-limiting-and-dos-protection" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting and DoS Protection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rate Limiting and DoS Protection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#token-bucket-algorithm-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Token Bucket Algorithm Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#secure-session-management" class="md-nav__link">
    <span class="md-ellipsis">
      Secure Session Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Secure Session Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#session-security-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Session Security Principles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprehensive-session-manager-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Comprehensive Session Manager Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cors-and-cross-origin-security" class="md-nav__link">
    <span class="md-ellipsis">
      CORS and Cross-Origin Security
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CORS and Cross-Origin Security">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-cors-security-model" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding CORS Security Model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprehensive-cors-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Comprehensive CORS Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-security-testing" class="md-nav__link">
    <span class="md-ellipsis">
      API Security Testing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Security Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#security-testing-methodology" class="md-nav__link">
    <span class="md-ellipsis">
      Security Testing Methodology
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automated-security-testing-framework" class="md-nav__link">
    <span class="md-ellipsis">
      Automated Security Testing Framework
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-a-complete-secure-rest-api" class="md-nav__link">
    <span class="md-ellipsis">
      Building a Complete Secure REST API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building a Complete Secure REST API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#secure-api-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Secure API Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-secure-api-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Complete Secure API Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-and-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Summary and Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary and Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#essential-security-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Essential Security Principles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Checklist
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Checklist">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-keys" class="md-nav__link">
    <span class="md-ellipsis">
      API Keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jwt-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      JWT Tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oauth-20" class="md-nav__link">
    <span class="md-ellipsis">
      OAuth 2.0
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-bucket-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      Token Bucket Algorithm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#progressive-penalties" class="md-nav__link">
    <span class="md-ellipsis">
      Progressive Penalties
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secure-session-ids" class="md-nav__link">
    <span class="md-ellipsis">
      Secure Session IDs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-features" class="md-nav__link">
    <span class="md-ellipsis">
      Security Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#origin-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Origin Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Security Patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automated-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Automated Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprehensive-coverage" class="md-nav__link">
    <span class="md-ellipsis">
      Comprehensive Coverage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-deployment-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Production Deployment Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-pitfalls-to-avoid" class="md-nav__link">
    <span class="md-ellipsis">
      Common Pitfalls to Avoid
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practice-questions-and-exercises" class="md-nav__link">
    <span class="md-ellipsis">
      Practice Questions and Exercises
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Practice Questions and Exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exercise-1-secure-registration-system" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 1: Secure Registration System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-2-api-rate-limiter" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 2: API Rate Limiter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-3-cors-security-manager" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 3: CORS Security Manager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-4-security-testing-suite" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 4: Security Testing Suite
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#case-study-e-commerce-api-security-breach" class="md-nav__link">
    <span class="md-ellipsis">
      Case Study: E-commerce API Security Breach
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Summary Checklist
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary Checklist">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authentication-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      Authentication &amp; Authorization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rate-limiting-dos-protection" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting &amp; DoS Protection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#input-validation-sanitization" class="md-nav__link">
    <span class="md-ellipsis">
      Input Validation &amp; Sanitization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session-management" class="md-nav__link">
    <span class="md-ellipsis">
      Session Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cors-cross-origin-security" class="md-nav__link">
    <span class="md-ellipsis">
      CORS &amp; Cross-Origin Security
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring &amp; Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-security" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment Security
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/edit/main/docs/Year12/SecureSoftwareArchitecture/Chapter-17-System-Security-and-APIs/17-01-Secure-API-Design/index.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/raw/main/docs/Year12/SecureSoftwareArchitecture/Chapter-17-System-Security-and-APIs/17-01-Secure-API-Design/index.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="171-secure-api-design">17.1 Secure API Design<a class="headerlink" href="#171-secure-api-design" title="Permanent link">&para;</a></h1>
<h2 id="why-it-matters">Why It Matters<a class="headerlink" href="#why-it-matters" title="Permanent link">&para;</a></h2>
<p>APIs (Application Programming Interfaces) are the backbone of modern applications, enabling communication between different systems, services, and client applications. However, APIs also represent significant attack surfaces that can expose sensitive data, business logic, and system resources to malicious actors.</p>
<p><strong>Real-world Impact:</strong></p>
<ul>
<li>
<p><strong>2019 Facebook API breach</strong>: Exposed 50 million user accounts through improper access token validation</p>
</li>
<li>
<p><strong>2021 Peloton API vulnerability</strong>: Allowed unauthorized access to private user data through missing authentication</p>
</li>
<li>
<p><strong>2020 Venmo API issue</strong>: Public transaction data accessible without proper authorization controls</p>
</li>
</ul>
<p>Secure API design is critical because APIs often:</p>
<ul>
<li>
<p>Handle sensitive user data and business information</p>
</li>
<li>
<p>Provide direct access to backend systems and databases</p>
</li>
<li>
<p>Are exposed to public networks and untrusted clients</p>
</li>
<li>
<p>Serve as integration points between multiple applications</p>
</li>
</ul>
<h2 id="core-security-principles-for-apis">Core Security Principles for APIs<a class="headerlink" href="#core-security-principles-for-apis" title="Permanent link">&para;</a></h2>
<h3 id="1-defense-in-depth">1. Defense in Depth<a class="headerlink" href="#1-defense-in-depth" title="Permanent link">&para;</a></h3>
<p>Implement multiple layers of security controls rather than relying on a single protection mechanism.</p>
<h3 id="2-principle-of-least-privilege">2. Principle of Least Privilege<a class="headerlink" href="#2-principle-of-least-privilege" title="Permanent link">&para;</a></h3>
<p>Grant the minimum access necessary for each API consumer to perform their intended function.</p>
<h3 id="3-fail-securely">3. Fail Securely<a class="headerlink" href="#3-fail-securely" title="Permanent link">&para;</a></h3>
<p>When errors occur, ensure the system fails to a secure state rather than exposing sensitive information.</p>
<h3 id="4-security-by-design">4. Security by Design<a class="headerlink" href="#4-security-by-design" title="Permanent link">&para;</a></h3>
<p>Build security controls into the API from the initial design phase, not as an afterthought.</p>
<h2 id="api-authentication-methods">API Authentication Methods<a class="headerlink" href="#api-authentication-methods" title="Permanent link">&para;</a></h2>
<h3 id="understanding-authentication-vs-authorization">Understanding Authentication vs Authorization<a class="headerlink" href="#understanding-authentication-vs-authorization" title="Permanent link">&para;</a></h3>
<p><strong>Authentication</strong> answers &ldquo;Who are you?&rdquo; - verifying the identity of the API consumer.
<strong>Authorization</strong> answers &ldquo;What can you do?&rdquo; - determining what resources and actions are permitted.</p>
<div class="diagram-container" data-container-id="kroki-diagram-0"><button class="diagram-expand-btn" onclick="openDiagramModal('kroki-diagram-0')">🔍 View Larger</button><div id="kroki-diagram-0" class="diagram-content"><p><svg xmlns="http://www.w3.org/2000/svg" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="416px" preserveAspectRatio="xMaxYMax meet" style="width:651px;height:416px;background:#FFFFFF;" version="1.1" viewBox="0 0 651 416" width="651px" zoomAndPan="magnify" id="Kroki" data-diagram-id="kroki-svg-0"><defs /><g><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="253.0625" width="8" x="29.2651" y="82.2969" /><line style="stroke:#000000;stroke-width:1;" x1="33" x2="33" y1="82.2969" y2="335.3594" /></g><g><title>API Gateway</title><rect fill="#000000" fill-opacity="0.00000" height="253.0625" width="8" x="224.4805" y="82.2969" /><line style="stroke:#000000;stroke-width:1;" x1="228.2588" x2="228.2588" y1="82.2969" y2="335.3594" /></g><g><title>Auth Service</title><rect fill="#000000" fill-opacity="0.00000" height="253.0625" width="8" x="387.7036" y="82.2969" /><line style="stroke:#000000;stroke-width:1;" x1="391.2017" x2="391.2017" y1="82.2969" y2="335.3594" /></g><g><title>API Service</title><rect fill="#000000" fill-opacity="0.00000" height="253.0625" width="8" x="515.3755" y="82.2969" /><line style="stroke:#000000;stroke-width:1;" x1="519.2056" x2="519.2056" y1="82.2969" y2="335.3594" /></g><g><title>User DB</title><rect fill="#000000" fill-opacity="0.00000" height="253.0625" width="8" x="612.918" y="82.2969" /><line style="stroke:#000000;stroke-width:1;" x1="616.5454" x2="616.5454" y1="82.2969" y2="335.3594" /></g><g class="participant participant-head" data-participant="Client"><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="40.5303" x="10" y="78.9951">Client</text><ellipse cx="33.2651" cy="14" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;" /><path d="M33.2651,22 L33.2651,49 M20.2651,30 L46.2651,30 M33.2651,49 L20.2651,64 M33.2651,49 L46.2651,64" fill="none" style="stroke:#000000;stroke-width:1;" /></g><g class="participant participant-tail" data-participant="Client"><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="40.5303" x="10" y="347.3545">Client</text><ellipse cx="33.2651" cy="359.6563" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;" /><path d="M33.2651,367.6563 L33.2651,394.6563 M20.2651,375.6563 L46.2651,375.6563 M33.2651,394.6563 L20.2651,409.6563 M33.2651,394.6563 L46.2651,409.6563" fill="none" style="stroke:#000000;stroke-width:1;" /></g><g class="participant participant-head" data-participant="Gateway"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="102.4434" x="177.2588" y="51" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="88.4434" x="184.2588" y="70.9951">API Gateway</text></g><g class="participant participant-tail" data-participant="Gateway"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="102.4434" x="177.2588" y="334.3594" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="88.4434" x="184.2588" y="354.3545">API Gateway</text></g><g class="participant participant-head" data-participant="Auth"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="103.0039" x="340.2017" y="51" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="89.0039" x="347.2017" y="70.9951">Auth Service</text></g><g class="participant participant-tail" data-participant="Auth"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="103.0039" x="340.2017" y="334.3594" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="89.0039" x="347.2017" y="354.3545">Auth Service</text></g><g class="participant participant-head" data-participant="API"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.3398" x="473.2056" y="51" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="78.3398" x="480.2056" y="70.9951">API Service</text></g><g class="participant participant-tail" data-participant="API"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.3398" x="473.2056" y="334.3594" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="78.3398" x="480.2056" y="354.3545">API Service</text></g><g class="participant participant-head" data-participant="DB"><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="56.7451" x="585.5454" y="78.9951">User DB</text><path d="M598.918,30 C598.918,20 616.918,20 616.918,20 C616.918,20 634.918,20 634.918,30 L634.918,56 C634.918,66 616.918,66 616.918,66 C616.918,66 598.918,66 598.918,56 L598.918,30" fill="#FFFFFF" style="stroke:#000000;stroke-width:1.5;" /><path d="M598.918,30 C598.918,40 616.918,40 616.918,40 C616.918,40 634.918,40 634.918,30" fill="none" style="stroke:#000000;stroke-width:1.5;" /></g><g class="participant participant-tail" data-participant="DB"><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="56.7451" x="585.5454" y="347.3545">User DB</text><path d="M598.918,360.6563 C598.918,350.6563 616.918,350.6563 616.918,350.6563 C616.918,350.6563 634.918,350.6563 634.918,360.6563 L634.918,386.6563 C634.918,396.6563 616.918,396.6563 616.918,396.6563 C616.918,396.6563 598.918,396.6563 598.918,386.6563 L598.918,360.6563" fill="#FFFFFF" style="stroke:#000000;stroke-width:1.5;" /><path d="M598.918,360.6563 C598.918,370.6563 616.918,370.6563 616.918,370.6563 C616.918,370.6563 634.918,370.6563 634.918,360.6563" fill="none" style="stroke:#000000;stroke-width:1.5;" /></g><g class="message" data-participant-1="Client" data-participant-2="Gateway"><polygon fill="#000000" points="216.4805,109.4297,226.4805,113.4297,216.4805,117.4297,220.4805,113.4297" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="33.2651" x2="222.4805" y1="113.4297" y2="113.4297" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="171.2153" x="40.2651" y="108.3638">API Request + Credentials</text></g><g class="message" data-participant-1="Gateway" data-participant-2="Auth"><polygon fill="#000000" points="379.7036,138.5625,389.7036,142.5625,379.7036,146.5625,383.7036,142.5625" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="228.4805" x2="385.7036" y1="142.5625" y2="142.5625" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="83.624" x="235.4805" y="137.4966">Authenticate</text></g><g class="message" data-participant-1="Auth" data-participant-2="DB"><polygon fill="#000000" points="604.918,167.6953,614.918,171.6953,604.918,175.6953,608.918,171.6953" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="391.7036" x2="610.918" y1="171.6953" y2="171.6953" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="131.498" x="398.7036" y="166.6294">Validate Credentials</text></g><g class="message" data-participant-1="DB" data-participant-2="Auth"><polygon fill="#000000" points="402.7036,196.8281,392.7036,200.8281,402.7036,204.8281,398.7036,200.8281" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="396.7036" x2="615.918" y1="200.8281" y2="200.8281" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="58.3667" x="408.7036" y="195.7622">User Info</text></g><g class="message" data-participant-1="Auth" data-participant-2="Gateway"><polygon fill="#000000" points="239.4805,225.9609,229.4805,229.9609,239.4805,233.9609,235.4805,229.9609" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="233.4805" x2="390.7036" y1="229.9609" y2="229.9609" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="139.2231" x="245.4805" y="224.895">Authentication Token</text></g><g class="message" data-participant-1="Gateway" data-participant-2="API"><polygon fill="#000000" points="507.3755,255.0938,517.3755,259.0938,507.3755,263.0938,511.3755,259.0938" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="228.4805" x2="513.3755" y1="259.0938" y2="259.0938" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="127.9751" x="235.4805" y="254.0278">Authorized Request</text></g><g class="message" data-participant-1="API" data-participant-2="Gateway"><polygon fill="#000000" points="239.4805,284.2266,229.4805,288.2266,239.4805,292.2266,235.4805,288.2266" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="233.4805" x2="518.3755" y1="288.2266" y2="288.2266" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="63.0195" x="245.4805" y="283.1606">Response</text></g><g class="message" data-participant-1="Gateway" data-participant-2="Client"><polygon fill="#000000" points="44.2651,313.3594,34.2651,317.3594,44.2651,321.3594,40.2651,317.3594" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="38.2651" x2="227.4805" y1="317.3594" y2="317.3594" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="87.7183" x="50.2651" y="312.2935">API Response</text></g></g></svg></p></div></div>
<h3 id="1-api-keys">1. API Keys<a class="headerlink" href="#1-api-keys" title="Permanent link">&para;</a></h3>
<p>API keys are simple tokens that identify and authenticate API consumers. While easy to implement, they have significant limitations.</p>
<h4 id="basic-api-key-implementation">Basic API Key Implementation<a class="headerlink" href="#basic-api-key-implementation" title="Permanent link">&para;</a></h4>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">APIKey</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents an API key with metadata&quot;&quot;&quot;</span>
    <span class="n">key_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">key_hash</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Hashed version of the actual key</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">expires_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">rate_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># requests per hour</span>
    <span class="n">allowed_endpoints</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># None means all endpoints</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APIKeyManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Secure API key management system&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">APIKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expires_days</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">rate_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">allowed_endpoints</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a new API key</span>
<span class="sd">        Returns: (key_id, actual_key) - store key_id, give actual_key to user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate cryptographically secure key</span>
        <span class="n">actual_key</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">key_id</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

        <span class="c1"># Hash the key for storage (never store plain text keys)</span>
        <span class="n">key_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">actual_key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="c1"># Set expiration</span>
        <span class="n">expires_at</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">expires_days</span><span class="p">:</span>
            <span class="n">expires_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">expires_days</span><span class="p">)</span>

        <span class="c1"># Create API key record</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">APIKey</span><span class="p">(</span>
            <span class="n">key_id</span><span class="o">=</span><span class="n">key_id</span><span class="p">,</span>
            <span class="n">key_hash</span><span class="o">=</span><span class="n">key_hash</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="n">expires_at</span><span class="o">=</span><span class="n">expires_at</span><span class="p">,</span>
            <span class="n">rate_limit</span><span class="o">=</span><span class="n">rate_limit</span><span class="p">,</span>
            <span class="n">allowed_endpoints</span><span class="o">=</span><span class="n">allowed_endpoints</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">key_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">[</span><span class="n">key_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">key_id</span><span class="p">,</span> <span class="n">actual_key</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provided_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">APIKey</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate an API key and return associated metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">provided_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Hash the provided key</span>
        <span class="n">provided_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">provided_key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

        <span class="c1"># Find matching key</span>
        <span class="k">for</span> <span class="n">key_id</span><span class="p">,</span> <span class="n">api_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">api_key</span><span class="o">.</span><span class="n">key_hash</span> <span class="o">==</span> <span class="n">provided_hash</span><span class="p">:</span>
                <span class="c1"># Check if key is active</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="c1"># Check if key has expired</span>
                <span class="k">if</span> <span class="n">api_key</span><span class="o">.</span><span class="n">expires_at</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">api_key</span><span class="o">.</span><span class="n">expires_at</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="k">return</span> <span class="n">api_key</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">revoke_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Revoke an API key&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">key_id</span><span class="p">]</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">track_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track API key usage for rate limiting&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">[</span><span class="n">key_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">[</span><span class="n">key_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;endpoint&#39;</span><span class="p">:</span> <span class="n">endpoint</span>
        <span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if API key is within rate limit (last hour)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">api_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Count requests in the last hour</span>
        <span class="n">one_hour_ago</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">recent_requests</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">req</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">[</span><span class="n">key_id</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">req</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">one_hour_ago</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_requests</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">api_key</span><span class="o">.</span><span class="n">rate_limit</span>

<span class="c1"># Example usage</span>
<span class="k">def</span><span class="w"> </span><span class="nf">api_key_authentication_example</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate API key authentication&quot;&quot;&quot;</span>
    <span class="n">key_manager</span> <span class="o">=</span> <span class="n">APIKeyManager</span><span class="p">()</span>

    <span class="c1"># Generate API key for a client</span>
    <span class="n">key_id</span><span class="p">,</span> <span class="n">actual_key</span> <span class="o">=</span> <span class="n">key_manager</span><span class="o">.</span><span class="n">generate_api_key</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Mobile App Client&quot;</span><span class="p">,</span>
        <span class="n">expires_days</span><span class="o">=</span><span class="mi">365</span><span class="p">,</span>
        <span class="n">rate_limit</span><span class="o">=</span><span class="mi">5000</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated API Key ID: </span><span class="si">{</span><span class="n">key_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API Key (give to client): </span><span class="si">{</span><span class="n">actual_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Simulate API request validation</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">authenticate_request</span><span class="p">(</span><span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate API request authentication&quot;&quot;&quot;</span>
        <span class="n">validated_key</span> <span class="o">=</span> <span class="n">key_manager</span><span class="o">.</span><span class="n">validate_api_key</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">validated_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid or expired API key&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">key_manager</span><span class="o">.</span><span class="n">check_rate_limit</span><span class="p">(</span><span class="n">validated_key</span><span class="o">.</span><span class="n">key_id</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Rate limit exceeded&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">429</span><span class="p">}</span>

        <span class="c1"># Track the usage</span>
        <span class="n">key_manager</span><span class="o">.</span><span class="n">track_usage</span><span class="p">(</span><span class="n">validated_key</span><span class="o">.</span><span class="n">key_id</span><span class="p">,</span> <span class="s2">&quot;/api/endpoint&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;authenticated&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;key_name&quot;</span><span class="p">:</span> <span class="n">validated_key</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;remaining_requests&quot;</span><span class="p">:</span> <span class="n">validated_key</span><span class="o">.</span><span class="n">rate_limit</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">key_manager</span><span class="o">.</span><span class="n">usage_tracking</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">validated_key</span><span class="o">.</span><span class="n">key_id</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">)</span>
        <span class="p">}</span>

    <span class="c1"># Test authentication</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticate_request</span><span class="p">(</span><span class="n">actual_key</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authentication result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">api_key_authentication_example</span><span class="p">()</span>
</code></pre>
</div>
<h4 id="api-key-security-best-practices">API Key Security Best Practices<a class="headerlink" href="#api-key-security-best-practices" title="Permanent link">&para;</a></h4>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="k">class</span><span class="w"> </span><span class="nc">SecureAPIKeyValidator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enhanced API key validation with security features&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failed_attempts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocked_ips</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_with_security_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                    <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate API key with additional security checks&quot;&quot;&quot;</span>

        <span class="c1"># Check if IP is blocked</span>
        <span class="k">if</span> <span class="n">client_ip</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocked_ips</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;IP address blocked&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">403</span><span class="p">}</span>

        <span class="c1"># Rate limiting on failed attempts</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_brute_force_attempts</span><span class="p">(</span><span class="n">client_ip</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_block_ip</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Too many failed attempts&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">429</span><span class="p">}</span>

        <span class="c1"># Validate API key</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid_api_key_format</span><span class="p">(</span><span class="n">api_key</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_failed_attempt</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid API key format&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">}</span>

        <span class="c1"># Additional timing attack protection</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Constant time delay</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;validated&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_valid_api_key_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate API key format to prevent injection&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check for only alphanumeric and safe characters</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[A-Za-z0-9_-]+$&#39;</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_track_failed_attempt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track failed authentication attempts&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">client_ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_attempts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failed_attempts</span><span class="p">[</span><span class="n">client_ip</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">failed_attempts</span><span class="p">[</span><span class="n">client_ip</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_brute_force_attempts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if IP has too many failed attempts&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">client_ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_attempts</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check last 15 minutes</span>
        <span class="n">fifteen_min_ago</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">recent_failures</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">attempt</span> <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_attempts</span><span class="p">[</span><span class="n">client_ip</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;</span> <span class="n">fifteen_min_ago</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_failures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span>  <span class="c1"># More than 10 failures in 15 minutes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_block_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Block an IP address&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocked_ips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Blocked IP </span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2"> due to suspicious activity&quot;</span><span class="p">)</span>
</code></pre>
</div>
<h3 id="2-json-web-tokens-jwt">2. JSON Web Tokens (JWT)<a class="headerlink" href="#2-json-web-tokens-jwt" title="Permanent link">&para;</a></h3>
<p>JWTs provide a stateless authentication mechanism that can carry user information and permissions within the token itself.</p>
<h4 id="jwt-implementation">JWT Implementation<a class="headerlink" href="#jwt-implementation" title="Permanent link">&para;</a></h4>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">JWTManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Secure JWT token management&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secret_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blacklisted_tokens</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">permissions</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> 
                      <span class="n">expires_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a JWT token with user information and permissions&quot;&quot;&quot;</span>

        <span class="c1"># Current time</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="c1"># Create payload</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s1">&#39;permissions&#39;</span><span class="p">:</span> <span class="n">permissions</span><span class="p">,</span>
            <span class="s1">&#39;iat&#39;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>  <span class="c1"># issued at</span>
            <span class="s1">&#39;exp&#39;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">expires_hours</span><span class="p">),</span>  <span class="c1"># expires</span>
            <span class="s1">&#39;jti&#39;</span><span class="p">:</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>  <span class="c1"># unique token ID for blacklisting</span>
        <span class="p">}</span>

        <span class="c1"># Generate token</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate JWT token and return payload if valid&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Check if token is blacklisted</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklisted_tokens</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Decode and validate token</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="n">token</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> 
                <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">payload</span>

        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Token has expired</span>
        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Token is invalid</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">revoke_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add token to blacklist (logout functionality)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blacklisted_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a new token from a valid existing token&quot;&quot;&quot;</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">old_token</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Revoke old token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revoke_token</span><span class="p">(</span><span class="n">old_token</span><span class="p">)</span>

        <span class="c1"># Generate new token with same permissions</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
            <span class="n">permissions</span><span class="o">=</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;permissions&#39;</span><span class="p">]</span>
        <span class="p">)</span>

<span class="c1"># JWT-based API authentication decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">jwt_required</span><span class="p">(</span><span class="n">permissions_required</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator for protecting API endpoints with JWT&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># In a real Flask/FastAPI app, you&#39;d get this from request headers</span>
            <span class="c1"># For demo purposes, we&#39;ll simulate it</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jwt_token&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">jwt_manager</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jwt_manager&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">jwt_manager</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;JWT manager not configured&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>

            <span class="c1"># Validate token</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt_manager</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid or expired token&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">}</span>

            <span class="c1"># Check permissions</span>
            <span class="k">if</span> <span class="n">permissions_required</span><span class="p">:</span>
                <span class="n">user_permissions</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permissions&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">perm</span> <span class="ow">in</span> <span class="n">user_permissions</span> <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">permissions_required</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Insufficient permissions&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">403</span><span class="p">}</span>

            <span class="c1"># Add user info to function call</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;current_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="c1"># Example protected API endpoints</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SecureAPI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Example API with JWT protection&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jwt_manager</span><span class="p">:</span> <span class="n">JWTManager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span> <span class="o">=</span> <span class="n">jwt_manager</span>

    <span class="nd">@jwt_required</span><span class="p">([</span><span class="s1">&#39;read_users&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jwt_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">jwt_manager</span><span class="p">:</span> <span class="n">JWTManager</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Protected endpoint requiring &#39;read_users&#39; permission&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;user1&quot;</span><span class="p">,</span> <span class="s2">&quot;user2&quot;</span><span class="p">,</span> <span class="s2">&quot;user3&quot;</span><span class="p">],</span>
            <span class="s2">&quot;accessed_by&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="nd">@jwt_required</span><span class="p">([</span><span class="s1">&#39;admin&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">jwt_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                   <span class="n">jwt_manager</span><span class="p">:</span> <span class="n">JWTManager</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Protected endpoint requiring &#39;admin&#39; permission&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> deleted&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deleted_by&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
        <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">jwt_authentication_example</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate JWT authentication&quot;&quot;&quot;</span>

    <span class="c1"># Initialize JWT manager</span>
    <span class="n">jwt_manager</span> <span class="o">=</span> <span class="n">JWTManager</span><span class="p">(</span><span class="n">secret_key</span><span class="o">=</span><span class="s2">&quot;your-secret-key-keep-this-secure&quot;</span><span class="p">)</span>

    <span class="c1"># Generate token for a user</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">jwt_manager</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span>
        <span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;read_users&quot;</span><span class="p">,</span> <span class="s2">&quot;write_posts&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated JWT: </span><span class="si">{</span><span class="n">token</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="c1"># Validate token</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt_manager</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token payload: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Test API access</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">SecureAPI</span><span class="p">(</span><span class="n">jwt_manager</span><span class="p">)</span>

    <span class="c1"># This should work (user has &#39;read_users&#39; permission)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_users</span><span class="p">(</span><span class="n">jwt_token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">jwt_manager</span><span class="o">=</span><span class="n">jwt_manager</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># This should fail (user doesn&#39;t have &#39;admin&#39; permission)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="s2">&quot;user456&quot;</span><span class="p">,</span> <span class="n">jwt_token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">jwt_manager</span><span class="o">=</span><span class="n">jwt_manager</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Admin action result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">jwt_authentication_example</span><span class="p">()</span>
</code></pre>
</div>
<h3 id="3-oauth-20-flow-implementation">3. OAuth 2.0 Flow Implementation<a class="headerlink" href="#3-oauth-20-flow-implementation" title="Permanent link">&para;</a></h3>
<p>OAuth 2.0 is an authorization framework that enables applications to obtain limited access to user accounts.</p>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OAuth2Manager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OAuth 2.0 authorization server implementation&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                 <span class="n">authorization_base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">token_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">client_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_secret</span> <span class="o">=</span> <span class="n">client_secret</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorization_base_url</span> <span class="o">=</span> <span class="n">authorization_base_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_url</span> <span class="o">=</span> <span class="n">token_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorization_codes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">access_tokens</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_authorization_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                 <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate OAuth authorization URL&quot;&quot;&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;response_type&#39;</span><span class="p">:</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span>
            <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
            <span class="s1">&#39;redirect_uri&#39;</span><span class="p">:</span> <span class="n">redirect_uri</span><span class="p">,</span>
            <span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="n">scope</span><span class="p">,</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">state</span> <span class="ow">or</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># Build authorization URL</span>
        <span class="n">authorization_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">authorization_base_url</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">authorization_url</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">exchange_code_for_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authorization_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                              <span class="n">redirect_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exchange authorization code for access token&quot;&quot;&quot;</span>

        <span class="c1"># Validate authorization code</span>
        <span class="k">if</span> <span class="n">authorization_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_codes</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">code_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_codes</span><span class="p">[</span><span class="n">authorization_code</span><span class="p">]</span>

        <span class="c1"># Check if code has expired (typically 10 minutes)</span>
        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">code_data</span><span class="p">[</span><span class="s1">&#39;expires_at&#39;</span><span class="p">]:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_codes</span><span class="p">[</span><span class="n">authorization_code</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Generate access token</span>
        <span class="n">access_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

        <span class="n">token_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;access_token&#39;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
            <span class="s1">&#39;refresh_token&#39;</span><span class="p">:</span> <span class="n">refresh_token</span><span class="p">,</span>
            <span class="s1">&#39;token_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Bearer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;expires_in&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>  <span class="c1"># 1 hour</span>
            <span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="n">code_data</span><span class="p">[</span><span class="s1">&#39;scope&#39;</span><span class="p">],</span>
            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">code_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">access_tokens</span><span class="p">[</span><span class="n">access_token</span><span class="p">]</span> <span class="o">=</span> <span class="n">token_data</span>

        <span class="c1"># Remove used authorization code</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_codes</span><span class="p">[</span><span class="n">authorization_code</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">token_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate OAuth access token&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">access_token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_tokens</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">token_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_tokens</span><span class="p">[</span><span class="n">access_token</span><span class="p">]</span>

        <span class="c1"># Check if token has expired</span>
        <span class="n">expires_at</span> <span class="o">=</span> <span class="n">token_data</span><span class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">token_data</span><span class="p">[</span><span class="s1">&#39;expires_in&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">expires_at</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_tokens</span><span class="p">[</span><span class="n">access_token</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">token_data</span>

<span class="c1"># OAuth-protected API endpoint</span>
<span class="k">def</span><span class="w"> </span><span class="nf">oauth_required</span><span class="p">(</span><span class="n">scopes_required</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator for OAuth-protected endpoints&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Get access token from Authorization header</span>
            <span class="c1"># In real implementation: token = request.headers.get(&#39;Authorization&#39;, &#39;&#39;).replace(&#39;Bearer &#39;, &#39;&#39;)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access_token&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">oauth_manager</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oauth_manager&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">oauth_manager</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;OAuth not configured&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>

            <span class="c1"># Validate token</span>
            <span class="n">token_data</span> <span class="o">=</span> <span class="n">oauth_manager</span><span class="o">.</span><span class="n">validate_access_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token_data</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid or expired access token&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">}</span>

            <span class="c1"># Check scopes</span>
            <span class="k">if</span> <span class="n">scopes_required</span><span class="p">:</span>
                <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">token_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scope&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">scope</span> <span class="ow">in</span> <span class="n">token_scopes</span> <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">scopes_required</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Insufficient scope&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">403</span><span class="p">}</span>

            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;token_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token_data</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="k">def</span><span class="w"> </span><span class="nf">oauth_authentication_example</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate OAuth 2.0 authentication flow&quot;&quot;&quot;</span>

    <span class="n">oauth_manager</span> <span class="o">=</span> <span class="n">OAuth2Manager</span><span class="p">(</span>
        <span class="n">client_id</span><span class="o">=</span><span class="s2">&quot;your-client-id&quot;</span><span class="p">,</span>
        <span class="n">client_secret</span><span class="o">=</span><span class="s2">&quot;your-client-secret&quot;</span><span class="p">,</span>
        <span class="n">authorization_base_url</span><span class="o">=</span><span class="s2">&quot;https://auth.example.com/oauth/authorize&quot;</span><span class="p">,</span>
        <span class="n">token_url</span><span class="o">=</span><span class="s2">&quot;https://auth.example.com/oauth/token&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Step 1: Generate authorization URL</span>
    <span class="n">auth_url</span> <span class="o">=</span> <span class="n">oauth_manager</span><span class="o">.</span><span class="n">generate_authorization_url</span><span class="p">(</span>
        <span class="n">redirect_uri</span><span class="o">=</span><span class="s2">&quot;https://yourapp.com/callback&quot;</span><span class="p">,</span>
        <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;read write&quot;</span><span class="p">,</span>
        <span class="n">state</span><span class="o">=</span><span class="s2">&quot;random-state-value&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authorization URL: </span><span class="si">{</span><span class="n">auth_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Step 2: Simulate user authorization (in real flow, user clicks auth_url)</span>
    <span class="c1"># This would be handled by the authorization server</span>
    <span class="n">authorization_code</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">oauth_manager</span><span class="o">.</span><span class="n">authorization_codes</span><span class="p">[</span><span class="n">authorization_code</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s1">&#39;user123&#39;</span><span class="p">,</span>
        <span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="s1">&#39;read write&#39;</span><span class="p">,</span>
        <span class="s1">&#39;expires_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># Step 3: Exchange code for token</span>
    <span class="n">token_data</span> <span class="o">=</span> <span class="n">oauth_manager</span><span class="o">.</span><span class="n">exchange_code_for_token</span><span class="p">(</span>
        <span class="n">authorization_code</span><span class="o">=</span><span class="n">authorization_code</span><span class="p">,</span>
        <span class="n">redirect_uri</span><span class="o">=</span><span class="s2">&quot;https://yourapp.com/callback&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Access token data: </span><span class="si">{</span><span class="n">token_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Step 4: Use token to access protected resource</span>
    <span class="nd">@oauth_required</span><span class="p">([</span><span class="s1">&#39;read&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_protected_data</span><span class="p">(</span><span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">oauth_manager</span><span class="p">:</span> <span class="n">OAuth2Manager</span><span class="p">,</span> <span class="n">token_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;This is protected data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">token_info</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
            <span class="s2">&quot;scopes&quot;</span><span class="p">:</span> <span class="n">token_info</span><span class="p">[</span><span class="s1">&#39;scope&#39;</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">get_protected_data</span><span class="p">(</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">token_data</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">],</span>
        <span class="n">oauth_manager</span><span class="o">=</span><span class="n">oauth_manager</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Protected resource access: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">oauth_authentication_example</span><span class="p">()</span>
</code></pre>
</div>
<h2 id="rate-limiting-and-dos-protection">Rate Limiting and DoS Protection<a class="headerlink" href="#rate-limiting-and-dos-protection" title="Permanent link">&para;</a></h2>
<p>Rate limiting is crucial for preventing abuse and ensuring fair resource allocation among API consumers.</p>
<h3 id="token-bucket-algorithm-implementation">Token Bucket Algorithm Implementation<a class="headerlink" href="#token-bucket-algorithm-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lock</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TokenBucket</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Token bucket for rate limiting&quot;&quot;&quot;</span>
    <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># Maximum number of tokens</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Current number of tokens</span>
    <span class="n">refill_rate</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Tokens added per second</span>
    <span class="n">last_refill</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Last refill timestamp</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RateLimiter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Advanced rate limiting with multiple algorithms&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buckets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TokenBucket</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">requests_per_second</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                         <span class="n">burst_capacity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenBucket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a rate limit for an identifier (IP, user, API key)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">burst_capacity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">burst_capacity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requests_per_second</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># Allow 10 seconds of burst</span>

        <span class="n">bucket</span> <span class="o">=</span> <span class="n">TokenBucket</span><span class="p">(</span>
            <span class="n">capacity</span><span class="o">=</span><span class="n">burst_capacity</span><span class="p">,</span>
            <span class="n">tokens</span><span class="o">=</span><span class="n">burst_capacity</span><span class="p">,</span>  <span class="c1"># Start with full bucket</span>
            <span class="n">refill_rate</span><span class="o">=</span><span class="n">requests_per_second</span><span class="p">,</span>
            <span class="n">last_refill</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buckets</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">bucket</span>

        <span class="k">return</span> <span class="n">bucket</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tokens_requested</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if request is allowed under rate limit&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="c1"># Get or create bucket</span>
            <span class="k">if</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buckets</span><span class="p">:</span>
                <span class="c1"># Default rate limit: 100 requests per second with burst of 1000</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_rate_limit</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buckets</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># Refill tokens based on elapsed time</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">bucket</span><span class="o">.</span><span class="n">last_refill</span>
            <span class="n">tokens_to_add</span> <span class="o">=</span> <span class="n">elapsed</span> <span class="o">*</span> <span class="n">bucket</span><span class="o">.</span><span class="n">refill_rate</span>
            <span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bucket</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span> <span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span> <span class="o">+</span> <span class="n">tokens_to_add</span><span class="p">)</span>
            <span class="n">bucket</span><span class="o">.</span><span class="n">last_refill</span> <span class="o">=</span> <span class="n">current_time</span>

            <span class="c1"># Check if enough tokens available</span>
            <span class="k">if</span> <span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span> <span class="o">&gt;=</span> <span class="n">tokens_requested</span><span class="p">:</span>
                <span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span> <span class="o">-=</span> <span class="n">tokens_requested</span>

                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s2">&quot;allowed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;remaining_tokens&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span><span class="p">),</span>
                    <span class="s2">&quot;reset_time&quot;</span><span class="p">:</span> <span class="n">current_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">bucket</span><span class="o">.</span><span class="n">capacity</span> <span class="o">-</span> <span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span> <span class="o">/</span> <span class="n">bucket</span><span class="o">.</span><span class="n">refill_rate</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Calculate when enough tokens will be available</span>
                <span class="n">tokens_needed</span> <span class="o">=</span> <span class="n">tokens_requested</span> <span class="o">-</span> <span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span>
                <span class="n">wait_time</span> <span class="o">=</span> <span class="n">tokens_needed</span> <span class="o">/</span> <span class="n">bucket</span><span class="o">.</span><span class="n">refill_rate</span>

                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s2">&quot;allowed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;retry_after&quot;</span><span class="p">:</span> <span class="n">wait_time</span><span class="p">,</span>
                    <span class="s2">&quot;remaining_tokens&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span>
                <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sliding_window_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">window_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">,</span> 
                           <span class="n">max_requests</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sliding window rate limiting (alternative algorithm)&quot;&quot;&quot;</span>

        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">window_start</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">window_seconds</span>

        <span class="c1"># Initialize request history if needed</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Remove old requests outside the window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">req_time</span> <span class="k">for</span> <span class="n">req_time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">req_time</span> <span class="o">&gt;</span> <span class="n">window_start</span>
        <span class="p">]</span>

        <span class="c1"># Check if within limit</span>
        <span class="n">current_requests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">identifier</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">current_requests</span> <span class="o">&lt;</span> <span class="n">max_requests</span><span class="p">:</span>
            <span class="c1"># Add current request</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">&quot;allowed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;requests_remaining&quot;</span><span class="p">:</span> <span class="n">max_requests</span> <span class="o">-</span> <span class="n">current_requests</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;window_reset&quot;</span><span class="p">:</span> <span class="n">window_start</span> <span class="o">+</span> <span class="n">window_seconds</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Calculate when window will reset</span>
            <span class="n">oldest_request</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">identifier</span><span class="p">])</span>
            <span class="n">reset_time</span> <span class="o">=</span> <span class="n">oldest_request</span> <span class="o">+</span> <span class="n">window_seconds</span>

            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">&quot;allowed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;retry_after&quot;</span><span class="p">:</span> <span class="n">reset_time</span> <span class="o">-</span> <span class="n">current_time</span><span class="p">,</span>
                <span class="s2">&quot;requests_remaining&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DDoSProtection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;DDoS protection with progressive penalties&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocked_ips</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_request_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                              <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze request patterns for DDoS indicators&quot;&quot;&quot;</span>

        <span class="c1"># Check if IP is already blocked</span>
        <span class="k">if</span> <span class="n">ip_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocked_ips</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;block&quot;</span><span class="p">,</span>
                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;IP previously blocked for suspicious activity&quot;</span>
            <span class="p">}</span>

        <span class="c1"># Progressive rate limiting based on suspicion level</span>
        <span class="n">suspicion_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_suspicion_level</span><span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">user_agent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">suspicion_level</span> <span class="o">==</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span>
            <span class="n">allowed</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">is_allowed</span><span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">requests_per_second</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">elif</span> <span class="n">suspicion_level</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span><span class="p">:</span>
            <span class="n">allowed</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">sliding_window_check</span><span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
            <span class="n">requests_per_second</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># high suspicion</span>
            <span class="n">allowed</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">sliding_window_check</span><span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">requests_per_second</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="c1"># Track consecutive violations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_violation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>

            <span class="c1"># Check if IP should be blocked</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_block_ip</span><span class="p">(</span><span class="n">ip_address</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blocked_ips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;block&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Too many rate limit violations&quot;</span>
                <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span> <span class="k">if</span> <span class="n">allowed</span> <span class="k">else</span> <span class="s2">&quot;rate_limit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;suspicion_level&quot;</span><span class="p">:</span> <span class="n">suspicion_level</span><span class="p">,</span>
            <span class="s2">&quot;rate_info&quot;</span><span class="p">:</span> <span class="n">info</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_suspicion_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                 <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate suspicion level based on various factors&quot;&quot;&quot;</span>

        <span class="n">suspicion_score</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Check user agent</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_agent</span> <span class="ow">or</span> <span class="n">user_agent</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;curl&quot;</span><span class="p">,</span> <span class="s2">&quot;wget&quot;</span><span class="p">,</span> <span class="s2">&quot;python-requests&quot;</span><span class="p">]:</span>
            <span class="n">suspicion_score</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="c1"># Check for suspicious endpoints</span>
        <span class="n">suspicious_endpoints</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/admin&quot;</span><span class="p">,</span> <span class="s2">&quot;/login&quot;</span><span class="p">,</span> <span class="s2">&quot;/api/auth&quot;</span><span class="p">,</span> <span class="s2">&quot;/.env&quot;</span><span class="p">,</span> <span class="s2">&quot;/config&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">suspicious</span> <span class="ow">in</span> <span class="n">endpoint</span> <span class="k">for</span> <span class="n">suspicious</span> <span class="ow">in</span> <span class="n">suspicious_endpoints</span><span class="p">):</span>
            <span class="n">suspicion_score</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Check request frequency from this IP</span>
        <span class="k">if</span> <span class="n">ip_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">request_history</span><span class="p">:</span>
            <span class="n">recent_requests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">ip_address</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">recent_requests</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>  <span class="c1"># Very high frequency</span>
                <span class="n">suspicion_score</span> <span class="o">+=</span> <span class="mi">3</span>
            <span class="k">elif</span> <span class="n">recent_requests</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">suspicion_score</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Determine level</span>
        <span class="k">if</span> <span class="n">suspicion_score</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;high&quot;</span>
        <span class="k">elif</span> <span class="n">suspicion_score</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;medium&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;low&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_track_violation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track rate limit violations&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ip_address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">[</span><span class="n">ip_address</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;violations&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;first_violation&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">[</span><span class="n">ip_address</span><span class="p">][</span><span class="s2">&quot;violations&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_block_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if IP should be blocked&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ip_address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">violations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">[</span><span class="n">ip_address</span><span class="p">][</span><span class="s2">&quot;violations&quot;</span><span class="p">]</span>
        <span class="n">first_violation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">[</span><span class="n">ip_address</span><span class="p">][</span><span class="s2">&quot;first_violation&quot;</span><span class="p">]</span>

        <span class="c1"># Block if more than 10 violations in the last hour</span>
        <span class="k">if</span> <span class="n">violations</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">first_violation</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3600</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rate_limiting_example</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate rate limiting and DDoS protection&quot;&quot;&quot;</span>

    <span class="c1"># Initialize protection systems</span>
    <span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">()</span>
    <span class="n">ddos_protection</span> <span class="o">=</span> <span class="n">DDoSProtection</span><span class="p">()</span>

    <span class="c1"># Create rate limits for different users</span>
    <span class="n">rate_limiter</span><span class="o">.</span><span class="n">create_rate_limit</span><span class="p">(</span><span class="s2">&quot;api_key_123&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>  <span class="c1"># 10 req/sec, burst 50</span>
    <span class="n">rate_limiter</span><span class="o">.</span><span class="n">create_rate_limit</span><span class="p">(</span><span class="s2">&quot;premium_user&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Higher limits</span>

    <span class="c1"># Simulate API requests</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_api_request</span><span class="p">(</span><span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate an API request with rate limiting&quot;&quot;&quot;</span>

        <span class="c1"># Check DDoS protection</span>
        <span class="n">ddos_result</span> <span class="o">=</span> <span class="n">ddos_protection</span><span class="o">.</span><span class="n">analyze_request_pattern</span><span class="p">(</span>
            <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
            <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;/api/data&quot;</span><span class="p">,</span>
            <span class="n">user_agent</span><span class="o">=</span><span class="s2">&quot;Mozilla/5.0 (legitimate browser)&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">ddos_result</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;block&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">403</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">ddos_result</span><span class="p">[</span><span class="s2">&quot;reason&quot;</span><span class="p">]}</span>

        <span class="c1"># Check rate limiting</span>
        <span class="n">allowed</span><span class="p">,</span> <span class="n">rate_info</span> <span class="o">=</span> <span class="n">rate_limiter</span><span class="o">.</span><span class="n">is_allowed</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">429</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Rate limit exceeded&quot;</span><span class="p">,</span>
                <span class="s2">&quot;retry_after&quot;</span><span class="p">:</span> <span class="n">rate_info</span><span class="p">[</span><span class="s2">&quot;retry_after&quot;</span><span class="p">]</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;API response data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rate_limit_remaining&quot;</span><span class="p">:</span> <span class="n">rate_info</span><span class="p">[</span><span class="s2">&quot;remaining_tokens&quot;</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="c1"># Test normal usage</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">simulate_api_request</span><span class="p">(</span><span class="s2">&quot;api_key_123&quot;</span><span class="p">,</span> <span class="s2">&quot;192.168.1.100&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Small delay between requests</span>

    <span class="c1"># Test rate limit exceeded</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">):</span>  <span class="c1"># Try to exceed rate limit</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">simulate_api_request</span><span class="p">(</span><span class="s2">&quot;api_key_123&quot;</span><span class="p">,</span> <span class="s2">&quot;192.168.1.100&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rate limited after </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> rapid requests&quot;</span><span class="p">)</span>
            <span class="k">break</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">rate_limiting_example</span><span class="p">()</span>
</code></pre>
</div>
<h2 id="secure-session-management">Secure Session Management<a class="headerlink" href="#secure-session-management" title="Permanent link">&para;</a></h2>
<p>Session management is critical for maintaining authenticated state between API requests while preventing session-related attacks.</p>
<h3 id="session-security-principles">Session Security Principles<a class="headerlink" href="#session-security-principles" title="Permanent link">&para;</a></h3>
<div class="diagram-container" data-container-id="kroki-diagram-1"><button class="diagram-expand-btn" onclick="openDiagramModal('kroki-diagram-1')">🔍 View Larger</button><div id="kroki-diagram-1" class="diagram-content"><p><svg xmlns="http://www.w3.org/2000/svg" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="533px" preserveAspectRatio="xMaxYMax meet" style="width:622px;height:533px;background:#FFFFFF;" version="1.1" viewBox="0 0 622 533" width="622px" zoomAndPan="magnify" id="Kroki" data-diagram-id="kroki-svg-1"><defs /><g><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="462.125" width="8" x="52.2651" y="36.2969" /><line style="stroke:#000000;stroke-width:1;" x1="56" x2="56" y1="36.2969" y2="498.4219" /></g><g><title>API Gateway</title><rect fill="#000000" fill-opacity="0.00000" height="462.125" width="8" x="300.1533" y="36.2969" /><line style="stroke:#000000;stroke-width:1;" x1="303.9316" x2="303.9316" y1="36.2969" y2="498.4219" /></g><g><title>Session Store</title><rect fill="#000000" fill-opacity="0.00000" height="462.125" width="8" x="435.9634" y="36.2969" /><line style="stroke:#000000;stroke-width:1;" x1="439.375" x2="439.375" y1="36.2969" y2="498.4219" /></g><g><title>API Service</title><rect fill="#000000" fill-opacity="0.00000" height="462.125" width="8" x="566.7217" y="36.2969" /><line style="stroke:#000000;stroke-width:1;" x1="570.5518" x2="570.5518" y1="36.2969" y2="498.4219" /></g><g class="participant participant-head" data-participant="Client"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="54.5303" x="29" y="5" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="40.5303" x="36" y="24.9951">Client</text></g><g class="participant participant-tail" data-participant="Client"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="54.5303" x="29" y="497.4219" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="40.5303" x="36" y="517.417">Client</text></g><g class="participant participant-head" data-participant="Gateway"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="102.4434" x="252.9316" y="5" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="88.4434" x="259.9316" y="24.9951">API Gateway</text></g><g class="participant participant-tail" data-participant="Gateway"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="102.4434" x="252.9316" y="497.4219" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="88.4434" x="259.9316" y="517.417">API Gateway</text></g><g class="participant participant-head" data-participant="Session"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="109.1768" x="385.375" y="5" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="95.1768" x="392.375" y="24.9951">Session Store</text></g><g class="participant participant-tail" data-participant="Session"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="109.1768" x="385.375" y="497.4219" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="95.1768" x="392.375" y="517.417">Session Store</text></g><g class="participant participant-head" data-participant="API"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.3398" x="524.5518" y="5" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="78.3398" x="531.5518" y="24.9951">API Service</text></g><g class="participant participant-tail" data-participant="API"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.3398" x="524.5518" y="497.4219" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="78.3398" x="531.5518" y="517.417">API Service</text></g><g class="message" data-participant-1="Client" data-participant-2="Gateway"><polygon fill="#000000" points="292.1533,63.4297,302.1533,67.4297,292.1533,71.4297,296.1533,67.4297" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="56.2651" x2="298.1533" y1="67.4297" y2="67.4297" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="92.8218" x="63.2651" y="62.3638">Login Request</text></g><g class="message" data-participant-1="Gateway" data-participant-2="Session"><polygon fill="#000000" points="427.9634,92.5625,437.9634,96.5625,427.9634,100.5625,431.9634,96.5625" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="304.1533" x2="433.9634" y1="96.5625" y2="96.5625" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="97.2144" x="311.1533" y="91.4966">Create Session</text></g><g class="message" data-participant-1="Session" data-participant-2="Gateway"><polygon fill="#000000" points="315.1533,121.6953,305.1533,125.6953,315.1533,129.6953,311.1533,125.6953" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="309.1533" x2="438.9634" y1="125.6953" y2="125.6953" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="67.5771" x="321.1533" y="120.6294">Session ID</text></g><g class="message" data-participant-1="Gateway" data-participant-2="Client"><polygon fill="#000000" points="67.2651,150.8281,57.2651,154.8281,67.2651,158.8281,63.2651,154.8281" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="61.2651" x2="303.1533" y1="154.8281" y2="154.8281" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="223.8882" x="73.2651" y="149.7622">Session Token (HTTP-Only Cookie)</text></g><path d="M10,167.8281 L10,192.8281 L351,192.8281 L351,177.8281 L341,167.8281 L10,167.8281" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M341,167.8281 L341,177.8281 L351,177.8281 L341,167.8281" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="166.334" x="93.0205" y="184.895">Subsequent API Requests</text><g class="message" data-participant-1="Client" data-participant-2="Gateway"><polygon fill="#000000" points="292.1533,215.0938,302.1533,219.0938,292.1533,223.0938,296.1533,219.0938" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="56.2651" x2="298.1533" y1="219.0938" y2="219.0938" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="195.1016" x="63.2651" y="214.0278">API Request + Session Cookie</text></g><g class="message" data-participant-1="Gateway" data-participant-2="Session"><polygon fill="#000000" points="427.9634,244.2266,437.9634,248.2266,427.9634,252.2266,431.9634,248.2266" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="304.1533" x2="433.9634" y1="248.2266" y2="248.2266" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="107.1294" x="311.1533" y="243.1606">Validate Session</text></g><g class="message" data-participant-1="Session" data-participant-2="Gateway"><polygon fill="#000000" points="315.1533,273.3594,305.1533,277.3594,315.1533,281.3594,311.1533,277.3594" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="309.1533" x2="438.9634" y1="277.3594" y2="277.3594" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="84.7729" x="321.1533" y="272.2935">Session Data</text></g><g class="message" data-participant-1="Gateway" data-participant-2="API"><polygon fill="#000000" points="558.7217,302.4922,568.7217,306.4922,558.7217,310.4922,562.7217,306.4922" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="304.1533" x2="564.7217" y1="306.4922" y2="306.4922" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="127.9751" x="311.1533" y="301.4263">Authorized Request</text></g><g class="message" data-participant-1="API" data-participant-2="Gateway"><polygon fill="#000000" points="315.1533,331.625,305.1533,335.625,315.1533,339.625,311.1533,335.625" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="309.1533" x2="569.7217" y1="335.625" y2="335.625" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="63.0195" x="321.1533" y="330.5591">Response</text></g><g class="message" data-participant-1="Gateway" data-participant-2="Client"><polygon fill="#000000" points="67.2651,360.7578,57.2651,364.7578,67.2651,368.7578,63.2651,364.7578" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="61.2651" x2="303.1533" y1="364.7578" y2="364.7578" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="87.7183" x="73.2651" y="359.6919">API Response</text></g><path d="M243,377.7578 L243,402.7578 L499,402.7578 L499,387.7578 L489,377.7578 L243,377.7578" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M489,377.7578 L489,387.7578 L499,387.7578 L489,377.7578" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="168.1431" x="282.7385" y="394.8247">Session Security Features</text><path d="M217,412.8906 L217,482.8906 L390,482.8906 L390,422.8906 L380,412.8906 L217,412.8906" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M380,412.8906 L380,422.8906 L390,422.8906 L380,412.8906" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="113.0771" x="223" y="429.9575">- CSRF Protection</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="108.8306" x="223" y="445.0903">- Secure Cookies</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="117.5078" x="223" y="460.2231">- Session Rotation</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="152.0962" x="223" y="475.356">- Timeout Management</text></g></svg></p></div></div>
<h3 id="comprehensive-session-manager-implementation">Comprehensive Session Manager Implementation<a class="headerlink" href="#comprehensive-session-manager-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lock</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SessionData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Secure session data structure&quot;&quot;&quot;</span>
    <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">last_accessed</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">expires_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">permissions</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">login_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SecureSessionManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Production-ready session management with security features&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_timeout_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> 
                 <span class="n">max_sessions_per_user</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SessionData</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># user_id -&gt; session_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_timeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">session_timeout_minutes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_sessions</span> <span class="o">=</span> <span class="n">max_sessions_per_user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="c1"># Security tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failed_logins</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                      <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">permissions</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new secure session</span>
<span class="sd">        Returns: (session_id, csrf_token)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="c1"># Check for too many sessions per user</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sessions</span><span class="p">:</span>
                    <span class="c1"># Remove oldest session</span>
                    <span class="n">oldest_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_revoke_session_internal</span><span class="p">(</span><span class="n">oldest_session</span><span class="p">)</span>

            <span class="c1"># Generate cryptographically secure session ID</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
            <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>

            <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="c1"># Create session data</span>
            <span class="n">session_data</span> <span class="o">=</span> <span class="n">SessionData</span><span class="p">(</span>
                <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">created_at</span><span class="o">=</span><span class="n">current_time</span><span class="p">,</span>
                <span class="n">last_accessed</span><span class="o">=</span><span class="n">current_time</span><span class="p">,</span>
                <span class="n">expires_at</span><span class="o">=</span><span class="n">current_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_timeout</span><span class="p">,</span>
                <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
                <span class="n">user_agent</span><span class="o">=</span><span class="n">user_agent</span><span class="p">,</span>
                <span class="n">permissions</span><span class="o">=</span><span class="n">permissions</span><span class="p">,</span>
                <span class="n">csrf_token</span><span class="o">=</span><span class="n">csrf_token</span>
            <span class="p">)</span>

            <span class="c1"># Store session</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_data</span>

            <span class="c1"># Track user sessions</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">csrf_token</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                        <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionData</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate session with security checks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">session_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="c1"># Check if session is active</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Check expiration</span>
            <span class="k">if</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">expires_at</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_revoke_session_internal</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Security checks</span>
            <span class="n">security_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_security_checks</span><span class="p">(</span>
                <span class="n">session</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="n">user_agent</span><span class="p">,</span> <span class="n">csrf_token</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">security_result</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Security check failed for session </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">security_result</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">security_result</span><span class="p">[</span><span class="s2">&quot;revoke&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_revoke_session_internal</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Update session activity</span>
            <span class="n">session</span><span class="o">.</span><span class="n">last_accessed</span> <span class="o">=</span> <span class="n">current_time</span>
            <span class="n">session</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_timeout</span>

            <span class="k">return</span> <span class="n">session</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_perform_security_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">SessionData</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform comprehensive security validation&quot;&quot;&quot;</span>

        <span class="c1"># IP address validation (detect session hijacking)</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">ip_address</span> <span class="o">!=</span> <span class="n">ip_address</span><span class="p">:</span>
            <span class="c1"># Log potential session hijacking</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;IP address mismatch for session </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">session_id</span><span class="si">}</span><span class="s2">: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;expected </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;revoke&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;IP address mismatch&quot;</span><span class="p">}</span>

        <span class="c1"># User agent validation (basic fingerprinting)</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">user_agent</span> <span class="o">!=</span> <span class="n">user_agent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;User agent mismatch for session </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Don&#39;t revoke for user agent changes, but log suspicious activity</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_suspicious_activity</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;user_agent_change&quot;</span><span class="p">)</span>

        <span class="c1"># CSRF token validation (for state-changing operations)</span>
        <span class="k">if</span> <span class="n">csrf_token</span> <span class="ow">and</span> <span class="n">csrf_token</span> <span class="o">!=</span> <span class="n">session</span><span class="o">.</span><span class="n">csrf_token</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;revoke&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid CSRF token&quot;</span><span class="p">}</span>

        <span class="c1"># Check for session fixation attacks</span>
        <span class="n">session_age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">session</span><span class="o">.</span><span class="n">created_at</span>
        <span class="k">if</span> <span class="n">session_age</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>  <span class="c1"># Force re-authentication after 24 hours</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;revoke&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Session too old&quot;</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;revoke&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Valid&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refresh session with new ID (prevent session fixation)</span>
<span class="sd">        Returns new session ID if successful</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">session_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">old_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>

            <span class="c1"># Generate new session ID</span>
            <span class="n">new_session_id</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
            <span class="n">new_csrf_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>

            <span class="c1"># Create new session with same data</span>
            <span class="n">new_session</span> <span class="o">=</span> <span class="n">SessionData</span><span class="p">(</span>
                <span class="n">session_id</span><span class="o">=</span><span class="n">new_session_id</span><span class="p">,</span>
                <span class="n">user_id</span><span class="o">=</span><span class="n">old_session</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>  <span class="c1"># Reset creation time</span>
                <span class="n">last_accessed</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="n">expires_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_timeout</span><span class="p">,</span>
                <span class="n">ip_address</span><span class="o">=</span><span class="n">old_session</span><span class="o">.</span><span class="n">ip_address</span><span class="p">,</span>
                <span class="n">user_agent</span><span class="o">=</span><span class="n">old_session</span><span class="o">.</span><span class="n">user_agent</span><span class="p">,</span>
                <span class="n">permissions</span><span class="o">=</span><span class="n">old_session</span><span class="o">.</span><span class="n">permissions</span><span class="p">,</span>
                <span class="n">csrf_token</span><span class="o">=</span><span class="n">new_csrf_token</span><span class="p">,</span>
                <span class="n">login_count</span><span class="o">=</span><span class="n">old_session</span><span class="o">.</span><span class="n">login_count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>

            <span class="c1"># Replace old session</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">new_session_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_session</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>

            <span class="c1"># Update user session tracking</span>
            <span class="n">user_sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">old_session</span><span class="o">.</span><span class="n">user_id</span><span class="p">]</span>
            <span class="n">user_sessions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
            <span class="n">user_sessions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_session_id</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session refreshed for user </span><span class="si">{</span><span class="n">old_session</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">new_session_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">revoke_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Revoke a specific session&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revoke_session_internal</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_revoke_session_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal session revocation (assumes lock is held)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">user_id</span>

        <span class="c1"># Remove from main storage</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>

        <span class="c1"># Remove from user session tracking</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

            <span class="c1"># Clean up empty user session list</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2"> revoked for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">revoke_all_user_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Revoke all sessions for a specific user&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>

            <span class="n">session_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">revoked_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="n">session_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revoke_session_internal</span><span class="p">(</span><span class="n">session_id</span><span class="p">):</span>
                    <span class="n">revoked_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Revoked </span><span class="si">{</span><span class="n">revoked_count</span><span class="si">}</span><span class="s2"> sessions for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">revoked_count</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_expired_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove expired sessions (should be run periodically)&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">expired_sessions</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">session</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">expires_at</span><span class="p">:</span>
                    <span class="n">expired_sessions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="n">expired_sessions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_revoke_session_internal</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">expired_sessions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaned up </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">expired_sessions</span><span class="p">)</span><span class="si">}</span><span class="s2"> expired sessions&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">expired_sessions</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all active sessions for a user&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="n">active_sessions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
                    <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
                    <span class="n">active_sessions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">,</span>
                        <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                        <span class="s1">&#39;last_accessed&#39;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">last_accessed</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                        <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">ip_address</span><span class="p">,</span>
                        <span class="s1">&#39;user_agent&#39;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">user_agent</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">user_agent</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="n">session</span><span class="o">.</span><span class="n">user_agent</span>
                    <span class="p">})</span>

            <span class="k">return</span> <span class="n">active_sessions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_track_suspicious_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">activity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track suspicious activity for security monitoring&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">activity_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">activity_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">activity_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

        <span class="c1"># Keep only recent activity (last 24 hours)</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">activity_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">timestamp</span> <span class="k">for</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">activity_type</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">cutoff</span>
        <span class="p">]</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SessionSecurityMiddleware</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Middleware for secure session handling in web applications&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_manager</span><span class="p">:</span> <span class="n">SecureSessionManager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_manager</span> <span class="o">=</span> <span class="n">session_manager</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_secure_cookie_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                        <span class="n">is_https</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate secure cookie attributes for session&quot;&quot;&quot;</span>

        <span class="n">cookie_attributes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;httponly&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Prevent XSS access to cookies</span>
            <span class="s1">&#39;secure&#39;</span><span class="p">:</span> <span class="n">is_https</span><span class="p">,</span>  <span class="c1"># Only send over HTTPS</span>
            <span class="s1">&#39;samesite&#39;</span><span class="p">:</span> <span class="s1">&#39;Strict&#39;</span><span class="p">,</span>  <span class="c1"># CSRF protection</span>
            <span class="s1">&#39;max_age&#39;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">,</span>  <span class="c1"># 30 minutes</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span>  <span class="c1"># Cookie available for entire domain</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">cookie_attributes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate request with session security checks&quot;&quot;&quot;</span>

        <span class="n">session_id</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ip_address</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip_address&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">user_agent</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_agent&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Validate session</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_manager</span><span class="o">.</span><span class="n">validate_session</span><span class="p">(</span>
            <span class="n">session_id</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="n">user_agent</span><span class="p">,</span> <span class="n">csrf_token</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid or expired session&#39;</span><span class="p">,</span>
                <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">401</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span>
            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
            <span class="s1">&#39;permissions&#39;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">permissions</span>
        <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">session_management_example</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate secure session management&quot;&quot;&quot;</span>

    <span class="c1"># Initialize session manager</span>
    <span class="n">session_manager</span> <span class="o">=</span> <span class="n">SecureSessionManager</span><span class="p">(</span>
        <span class="n">session_timeout_minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">max_sessions_per_user</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">)</span>

    <span class="c1"># Create session for user login</span>
    <span class="n">session_id</span><span class="p">,</span> <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">session_manager</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
        <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">,</span>
        <span class="n">user_agent</span><span class="o">=</span><span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36&quot;</span><span class="p">,</span>
        <span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created: </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSRF token: </span><span class="si">{</span><span class="n">csrf_token</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="c1"># Validate session</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">session_manager</span><span class="o">.</span><span class="n">validate_session</span><span class="p">(</span>
        <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
        <span class="n">ip_address</span><span class="o">=</span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">,</span>
        <span class="n">user_agent</span><span class="o">=</span><span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36&quot;</span><span class="p">,</span>
        <span class="n">csrf_token</span><span class="o">=</span><span class="n">csrf_token</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session valid for user: </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Permissions: </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">permissions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Demonstrate session refresh (prevent fixation)</span>
    <span class="n">new_session_id</span> <span class="o">=</span> <span class="n">session_manager</span><span class="o">.</span><span class="n">refresh_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session refreshed: </span><span class="si">{</span><span class="n">new_session_id</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="c1"># Show user&#39;s active sessions</span>
    <span class="n">active_sessions</span> <span class="o">=</span> <span class="n">session_manager</span><span class="o">.</span><span class="n">get_user_sessions</span><span class="p">(</span><span class="s2">&quot;user123&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active sessions for user: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">active_sessions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Clean up</span>
    <span class="n">session_manager</span><span class="o">.</span><span class="n">revoke_all_user_sessions</span><span class="p">(</span><span class="s2">&quot;user123&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All user sessions revoked&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">session_management_example</span><span class="p">()</span>
</code></pre>
</div>
<h2 id="cors-and-cross-origin-security">CORS and Cross-Origin Security<a class="headerlink" href="#cors-and-cross-origin-security" title="Permanent link">&para;</a></h2>
<p>Cross-Origin Resource Sharing (CORS) is a critical security mechanism that controls how web applications can access resources from different domains.</p>
<h3 id="understanding-cors-security-model">Understanding CORS Security Model<a class="headerlink" href="#understanding-cors-security-model" title="Permanent link">&para;</a></h3>
<div class="diagram-container" data-container-id="kroki-diagram-2"><button class="diagram-expand-btn" onclick="openDiagramModal('kroki-diagram-2')">🔍 View Larger</button><div id="kroki-diagram-2" class="diagram-content"><p><svg xmlns="http://www.w3.org/2000/svg" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="745px" preserveAspectRatio="xMaxYMax meet" style="width:565px;height:745px;background:#FFFFFF;" version="1.1" viewBox="0 0 565 745" width="565px" zoomAndPan="magnify" id="Kroki" data-diagram-id="kroki-svg-2"><defs /><g><rect fill="#FFFFFF" height="309.3984" style="stroke:#000000;stroke-width:1;" width="486.0713" x="30" y="367.1875" /><rect fill="#FFFFFF" height="130.3359" style="stroke:none;stroke-width:1;" width="486.0713" x="30" y="546.25" /><g><title>Web Browser</title><rect fill="#000000" fill-opacity="0.00000" height="640.9922" width="8" x="99.416" y="52.5938" /><line style="stroke:#000000;stroke-width:1;" x1="103" x2="103" y1="52.5938" y2="693.5859" /></g><g><title>Client App</title><rect fill="#000000" fill-opacity="0.00000" height="640.9922" width="8" x="266.9531" y="52.5938" /><line style="stroke:#000000;stroke-width:1;" x1="270.0635" x2="270.0635" y1="52.5938" y2="693.5859" /></g><g><title>API Server</title><rect fill="#000000" fill-opacity="0.00000" height="640.9922" width="8" x="424.457" y="52.5938" /><line style="stroke:#000000;stroke-width:1;" x1="427.8428" x2="427.8428" y1="52.5938" y2="693.5859" /></g><g class="participant participant-head" data-participant="Browser"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="106.832" x="50" y="21.2969" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="92.832" x="57" y="41.292">Web Browser</text></g><g class="participant participant-tail" data-participant="Browser"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="106.832" x="50" y="692.5859" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="92.832" x="57" y="712.5811">Web Browser</text></g><g class="participant participant-head" data-participant="Client"><rect fill="#FFFFFF" height="46.5938" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="119.7793" x="211.0635" y="5" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="72.3311" x="234.7876" y="24.9951">Client App</text><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="105.7793" x="218.0635" y="41.292">(example.com)</text></g><g class="participant participant-tail" data-participant="Client"><rect fill="#FFFFFF" height="46.5938" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="119.7793" x="211.0635" y="692.5859" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="72.3311" x="234.7876" y="712.5811">Client App</text><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="105.7793" x="218.0635" y="728.8779">(example.com)</text></g><g class="participant participant-head" data-participant="API"><rect fill="#FFFFFF" height="46.5938" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="135.2285" x="360.8428" y="5" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="72.5088" x="392.2026" y="24.9951">API Server</text><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="121.2285" x="367.8428" y="41.292">(api.service.com)</text></g><g class="participant participant-tail" data-participant="API"><rect fill="#FFFFFF" height="46.5938" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="135.2285" x="360.8428" y="692.5859" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="72.5088" x="392.2026" y="712.5811">API Server</text><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="121.2285" x="367.8428" y="728.8779">(api.service.com)</text></g><g class="message" data-participant-1="Browser" data-participant-2="Client"><polygon fill="#000000" points="258.9531,79.7266,268.9531,83.7266,258.9531,87.7266,262.9531,83.7266" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="264.9531" y1="83.7266" y2="83.7266" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="107.2563" x="110.416" y="78.6606">Load application</text></g><g class="message" data-participant-1="Client" data-participant-2="Browser"><polygon fill="#000000" points="114.416,123.9922,104.416,127.9922,114.416,131.9922,110.416,127.9922" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="108.416" x2="269.9531" y1="127.9922" y2="127.9922" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="130.4253" x="120.416" y="107.7935">Make API request to</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="96.8398" x="120.416" y="122.9263">different origin</text></g><path d="M10,140.9922 L10,165.9922 L197,165.9922 L197,150.9922 L187,140.9922 L10,140.9922" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M187,140.9922 L187,150.9922 L197,150.9922 L187,140.9922" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="166.9751" x="16" y="158.0591">Same-Origin Policy Check</text><g class="message" data-participant-1="Browser" data-participant-2="Browser"><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="145.416" y1="222.5234" y2="222.5234" /><line style="stroke:#000000;stroke-width:1;" x1="145.416" x2="145.416" y1="222.5234" y2="235.5234" /><line style="stroke:#000000;stroke-width:1;" x1="104.416" x2="145.416" y1="235.5234" y2="235.5234" /><polygon fill="#000000" points="114.416,231.5234,104.416,235.5234,114.416,239.5234,110.416,235.5234" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="135.8843" x="110.416" y="187.1919">Origin: example.com</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="153.5371" x="110.416" y="202.3247">Target: api.service.com</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="120.7261" x="110.416" y="217.4575">(Different origins!)</text></g><g class="message" data-participant-1="Browser" data-participant-2="API"><polygon fill="#000000" points="416.457,290.9219,426.457,294.9219,416.457,298.9219,420.457,294.9219" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="422.457" y1="294.9219" y2="294.9219" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="120.104" x="110.416" y="259.5903">Preflight REQUEST</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="120.0596" x="110.416" y="274.7231">OPTIONS /api/data</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="135.8843" x="110.416" y="289.856">Origin: example.com</text></g><g class="message" data-participant-1="API" data-participant-2="API"><line style="stroke:#000000;stroke-width:1;" x1="428.457" x2="470.457" y1="339.1875" y2="339.1875" /><line style="stroke:#000000;stroke-width:1;" x1="470.457" x2="470.457" y1="339.1875" y2="352.1875" /><line style="stroke:#000000;stroke-width:1;" x1="429.457" x2="470.457" y1="352.1875" y2="352.1875" /><polygon fill="#000000" points="439.457,348.1875,429.457,352.1875,439.457,356.1875,435.457,352.1875" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="123.1191" x="435.457" y="318.9888">Check CORS policy</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="110.0874" x="435.457" y="334.1216">for example.com</text></g><path d="M30,367.1875 L94.4429,367.1875 L94.4429,374.3203 L84.4429,384.3203 L30,384.3203 L30,367.1875" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><rect fill="none" height="309.3984" style="stroke:#000000;stroke-width:1;" width="486.0713" x="30" y="367.1875" /><text fill="#000000" font-family="Arial" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.4429" x="45" y="380.2544">alt</text><text fill="#000000" font-family="Arial" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="96.8086" x="109.4429" y="379.3979">[CORS Allowed]</text><g class="message" data-participant-1="API" data-participant-2="Browser"><polygon fill="#000000" points="114.416,431.7188,104.416,435.7188,114.416,439.7188,110.416,435.7188" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="108.416" x2="427.457" y1="435.7188" y2="435.7188" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="47.7026" x="120.416" y="400.3872">200 OK</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="276.6689" x="120.416" y="415.52">Access-Control-Allow-Origin: example.com</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="273.584" x="120.416" y="430.6528">Access-Control-Allow-Methods: GET, POST</text></g><g class="message" data-participant-1="Browser" data-participant-2="API"><polygon fill="#000000" points="416.457,475.9844,426.457,479.9844,416.457,483.9844,420.457,479.9844" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="422.457" y1="479.9844" y2="479.9844" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="106.4883" x="110.416" y="459.7856">Actual REQUEST</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="88.2324" x="110.416" y="474.9185">GET /api/data</text></g><g class="message" data-participant-1="API" data-participant-2="Browser"><polygon fill="#000000" points="114.416,505.1172,104.416,509.1172,114.416,513.1172,110.416,509.1172" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="108.416" x2="427.457" y1="509.1172" y2="509.1172" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="97.8999" x="120.416" y="504.0513">200 OK + Data</text></g><g class="message" data-participant-1="Browser" data-participant-2="Client"><polygon fill="#000000" points="258.9531,534.25,268.9531,538.25,258.9531,542.25,262.9531,538.25" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="264.9531" y1="538.25" y2="538.25" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="115.7939" x="110.416" y="533.1841">Success response</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="30" x2="516.0713" y1="547.25" y2="547.25" /><text fill="#000000" font-family="Arial" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="91.228" x="35" y="557.4604">[CORS Denied]</text><g class="message" data-participant-1="API" data-participant-2="Browser"><polygon fill="#000000" points="114.416,593.3203,104.416,597.3203,114.416,601.3203,110.416,597.3203" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="108.416" x2="427.457" y1="597.3203" y2="597.3203" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="94.3262" x="120.416" y="577.1216">403 Forbidden</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="125.252" x="120.416" y="592.2544">(No CORS headers)</text></g><g class="message" data-participant-1="Browser" data-participant-2="Browser"><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="145.416" y1="626.4531" y2="626.4531" /><line style="stroke:#000000;stroke-width:1;" x1="145.416" x2="145.416" y1="626.4531" y2="639.4531" /><line style="stroke:#000000;stroke-width:1;" x1="104.416" x2="145.416" y1="639.4531" y2="639.4531" /><polygon fill="#000000" points="114.416,635.4531,104.416,639.4531,114.416,643.4531,110.416,639.4531" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="98.6235" x="110.416" y="621.3872">Block response</text></g><g class="message" data-participant-1="Browser" data-participant-2="Client"><polygon fill="#000000" points="258.9531,664.5859,268.9531,668.5859,258.9531,672.5859,262.9531,668.5859" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="264.9531" y1="668.5859" y2="668.5859" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="72.9282" x="110.416" y="663.52">CORS Error</text></g></g></svg></p></div></div>
<h3 id="comprehensive-cors-implementation">Comprehensive CORS Implementation<a class="headerlink" href="#comprehensive-cors-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CORSPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CORS policy configuration&quot;&quot;&quot;</span>
    <span class="n">allowed_origins</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">allowed_methods</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">allowed_headers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">exposed_headers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">allow_credentials</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">max_age</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># Preflight cache duration in seconds</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CORSManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Production-ready CORS management with security features&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CORSPolicy</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CORSPolicy</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Security patterns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dangerous_origins</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">r</span><span class="s1">&#39;.*\.evil\.com$&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;.*malicious.*&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;file://&#39;</span><span class="p">,</span>  <span class="c1"># Block file:// origins</span>
            <span class="sa">r</span><span class="s1">&#39;data:&#39;</span><span class="p">,</span>    <span class="c1"># Block data: origins</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">CORSPolicy</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a named CORS policy&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="n">policy_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_default_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">CORSPolicy</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set default CORS policy&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span> <span class="o">=</span> <span class="n">policy</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_secure_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allowed_origins</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                           <span class="n">allow_credentials</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CORSPolicy</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a secure CORS policy with safe defaults&quot;&quot;&quot;</span>

        <span class="c1"># Validate origins for security</span>
        <span class="n">validated_origins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">allowed_origins</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_safe_origin</span><span class="p">(</span><span class="n">origin</span><span class="p">):</span>
                <span class="n">validated_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Potentially unsafe origin blocked: </span><span class="si">{</span><span class="n">origin</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">CORSPolicy</span><span class="p">(</span>
            <span class="n">allowed_origins</span><span class="o">=</span><span class="n">validated_origins</span><span class="p">,</span>
            <span class="n">allowed_methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">],</span>
            <span class="n">allowed_headers</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;X-Requested-With&#39;</span><span class="p">,</span>
                <span class="s1">&#39;X-CSRF-Token&#39;</span>
            <span class="p">],</span>
            <span class="n">exposed_headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X-Total-Count&#39;</span><span class="p">,</span> <span class="s1">&#39;X-Page-Count&#39;</span><span class="p">],</span>
            <span class="n">allow_credentials</span><span class="o">=</span><span class="n">allow_credentials</span><span class="p">,</span>
            <span class="n">max_age</span><span class="o">=</span><span class="mi">86400</span>  <span class="c1"># 24 hours</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_safe_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate origin against security patterns&quot;&quot;&quot;</span>

        <span class="c1"># Check against dangerous patterns</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dangerous_origins</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Validate URL format</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># Only allow HTTP/HTTPS</span>
            <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_preflight_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                <span class="n">headers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle CORS preflight request&quot;&quot;&quot;</span>

        <span class="c1"># Get applicable policy</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_policy</span><span class="p">(</span><span class="n">policy_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cors_denial</span><span class="p">()</span>

        <span class="c1"># Validate origin</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_origin_allowed</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cors_denial</span><span class="p">()</span>

        <span class="c1"># Validate method</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">allowed_methods</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cors_denial</span><span class="p">()</span>

        <span class="c1"># Validate headers</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_header_allowed</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cors_denial</span><span class="p">()</span>

        <span class="c1"># Create successful preflight response</span>
        <span class="n">response_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_origin_response</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">policy</span><span class="p">),</span>
            <span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">allowed_methods</span><span class="p">),</span>
            <span class="s1">&#39;Access-Control-Allow-Headers&#39;</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">allowed_headers</span><span class="p">),</span>
            <span class="s1">&#39;Access-Control-Max-Age&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">max_age</span><span class="p">),</span>
            <span class="s1">&#39;Vary&#39;</span><span class="p">:</span> <span class="s1">&#39;Origin&#39;</span>  <span class="c1"># Important for caching</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">allow_credentials</span><span class="p">:</span>
            <span class="n">response_headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Credentials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>

        <span class="k">return</span> <span class="n">response_headers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_actual_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle actual CORS request&quot;&quot;&quot;</span>

        <span class="c1"># Get applicable policy</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_policy</span><span class="p">(</span><span class="n">policy_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cors_denial</span><span class="p">()</span>

        <span class="c1"># Validate origin</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_origin_allowed</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cors_denial</span><span class="p">()</span>

        <span class="c1"># Create response headers</span>
        <span class="n">response_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_origin_response</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">policy</span><span class="p">),</span>
            <span class="s1">&#39;Vary&#39;</span><span class="p">:</span> <span class="s1">&#39;Origin&#39;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">exposed_headers</span><span class="p">:</span>
            <span class="n">response_headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Expose-Headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">exposed_headers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">allow_credentials</span><span class="p">:</span>
            <span class="n">response_headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Credentials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>

        <span class="k">return</span> <span class="n">response_headers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CORSPolicy</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get policy by name or default&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">policy_name</span> <span class="ow">and</span> <span class="n">policy_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="n">policy_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_origin_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">CORSPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if origin is allowed by policy&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">origin</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check exact matches and wildcards</span>
        <span class="k">for</span> <span class="n">allowed_origin</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">allowed_origins</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">allowed_origin</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                <span class="c1"># Wildcard only allowed if credentials are disabled</span>
                <span class="k">return</span> <span class="ow">not</span> <span class="n">policy</span><span class="o">.</span><span class="n">allow_credentials</span>
            <span class="k">elif</span> <span class="n">allowed_origin</span> <span class="o">==</span> <span class="n">origin</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_origin_pattern</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">allowed_origin</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_match_origin_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Match origin against pattern (supports simple wildcards)&quot;&quot;&quot;</span>

        <span class="c1"># Convert simple wildcard pattern to regex</span>
        <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
            <span class="n">regex_pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;[^.]*&#39;</span><span class="p">)</span>
            <span class="n">regex_pattern</span> <span class="o">=</span> <span class="n">regex_pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;^</span><span class="si">{</span><span class="n">regex_pattern</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">origin</span> <span class="o">==</span> <span class="n">pattern</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_header_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">CORSPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if header is allowed&quot;&quot;&quot;</span>

        <span class="c1"># Case-insensitive header comparison</span>
        <span class="n">header_lower</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">allowed_headers_lower</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">allowed_headers</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">header_lower</span> <span class="ow">in</span> <span class="n">allowed_headers_lower</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_origin_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">CORSPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get appropriate origin response value&quot;&quot;&quot;</span>

        <span class="c1"># If credentials are allowed, must echo exact origin (not wildcard)</span>
        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">allow_credentials</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">origin</span>

        <span class="c1"># Check if wildcard is in allowed origins</span>
        <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">allowed_origins</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;*&#39;</span>

        <span class="k">return</span> <span class="n">origin</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_cors_denial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create CORS denial response (empty headers)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CORSSecurityMiddleware</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CORS security middleware for web applications&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cors_manager</span><span class="p">:</span> <span class="n">CORSManager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span> <span class="o">=</span> <span class="n">cors_manager</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> 
                       <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process request with CORS handling&quot;&quot;&quot;</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span>

        <span class="c1"># Handle preflight requests</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
            <span class="n">requested_method</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access_control_request_method&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">requested_headers</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access_control_request_headers&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">requested_headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">requested_headers</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

            <span class="n">cors_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">handle_preflight_request</span><span class="p">(</span>
                <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">requested_method</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">requested_headers</span><span class="p">,</span>
                <span class="n">policy_name</span><span class="o">=</span><span class="n">policy_name</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cors_headers</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">403</span><span class="p">,</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;CORS policy violation&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="p">{}</span>
                <span class="p">}</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="n">cors_headers</span>
            <span class="p">}</span>

        <span class="c1"># Handle actual requests</span>
        <span class="n">cors_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">handle_actual_request</span><span class="p">(</span>
            <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
            <span class="n">policy_name</span><span class="o">=</span><span class="n">policy_name</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cors_headers</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">403</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;CORS policy violation&#39;</span><span class="p">,</span>
                <span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="n">cors_headers</span>
        <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cors_security_example</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate CORS security implementation&quot;&quot;&quot;</span>

    <span class="c1"># Initialize CORS manager</span>
    <span class="n">cors_manager</span> <span class="o">=</span> <span class="n">CORSManager</span><span class="p">()</span>

    <span class="c1"># Create secure policies for different environments</span>

    <span class="c1"># Development policy (more permissive)</span>
    <span class="n">dev_policy</span> <span class="o">=</span> <span class="n">cors_manager</span><span class="o">.</span><span class="n">create_secure_policy</span><span class="p">(</span>
        <span class="n">allowed_origins</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;http://localhost:3000&#39;</span><span class="p">,</span>
            <span class="s1">&#39;http://localhost:8080&#39;</span><span class="p">,</span>
            <span class="s1">&#39;http://127.0.0.1:3000&#39;</span>
        <span class="p">],</span>
        <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Production policy (restrictive)</span>
    <span class="n">prod_policy</span> <span class="o">=</span> <span class="n">cors_manager</span><span class="o">.</span><span class="n">create_secure_policy</span><span class="p">(</span>
        <span class="n">allowed_origins</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;https://myapp.com&#39;</span><span class="p">,</span>
            <span class="s1">&#39;https://www.myapp.com&#39;</span><span class="p">,</span>
            <span class="s1">&#39;https://admin.myapp.com&#39;</span>
        <span class="p">],</span>
        <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Public API policy (no credentials)</span>
    <span class="n">public_policy</span> <span class="o">=</span> <span class="n">CORSPolicy</span><span class="p">(</span>
        <span class="n">allowed_origins</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
        <span class="n">allowed_methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">],</span>
        <span class="n">allowed_headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">],</span>
        <span class="n">exposed_headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X-Rate-Limit-Remaining&#39;</span><span class="p">],</span>
        <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">max_age</span><span class="o">=</span><span class="mi">3600</span>
    <span class="p">)</span>

    <span class="c1"># Register policies</span>
    <span class="n">cors_manager</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="s1">&#39;development&#39;</span><span class="p">,</span> <span class="n">dev_policy</span><span class="p">)</span>
    <span class="n">cors_manager</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="n">prod_policy</span><span class="p">)</span>
    <span class="n">cors_manager</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="s1">&#39;public&#39;</span><span class="p">,</span> <span class="n">public_policy</span><span class="p">)</span>
    <span class="n">cors_manager</span><span class="o">.</span><span class="n">set_default_policy</span><span class="p">(</span><span class="n">prod_policy</span><span class="p">)</span>

    <span class="c1"># Create middleware</span>
    <span class="n">cors_middleware</span> <span class="o">=</span> <span class="n">CORSSecurityMiddleware</span><span class="p">(</span><span class="n">cors_manager</span><span class="p">)</span>

    <span class="c1"># Simulate preflight request</span>
    <span class="n">preflight_request</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;https://myapp.com&#39;</span><span class="p">,</span>
        <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;access_control_request_method&#39;</span><span class="p">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
        <span class="s1">&#39;access_control_request_headers&#39;</span><span class="p">:</span> <span class="s1">&#39;Content-Type, Authorization&#39;</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">cors_middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">preflight_request</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preflight result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Simulate actual request</span>
    <span class="n">actual_request</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;https://myapp.com&#39;</span><span class="p">,</span>
        <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;POST&#39;</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">cors_middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">actual_request</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Actual request result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Test blocked origin</span>
    <span class="n">blocked_request</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;https://malicious-site.com&#39;</span><span class="p">,</span>
        <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;GET&#39;</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">cors_middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">blocked_request</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Blocked request result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">cors_security_example</span><span class="p">()</span>
</code></pre>
</div>
<h2 id="api-security-testing">API Security Testing<a class="headerlink" href="#api-security-testing" title="Permanent link">&para;</a></h2>
<p>Security testing is essential for identifying vulnerabilities in API implementations before they can be exploited by attackers.</p>
<h3 id="security-testing-methodology">Security Testing Methodology<a class="headerlink" href="#security-testing-methodology" title="Permanent link">&para;</a></h3>
<div class="diagram-container" data-container-id="kroki-diagram-3"><button class="diagram-expand-btn" onclick="openDiagramModal('kroki-diagram-3')">🔍 View Larger</button><div id="kroki-diagram-3" class="diagram-content"><p><svg xmlns="http://www.w3.org/2000/svg" contentStyleType="text/css" data-diagram-type="ACTIVITY" height="452px" preserveAspectRatio="xMaxYMax meet" style="width:1351px;height:452px;background:#FFFFFF;" version="1.1" viewBox="0 0 1351 452" width="1351px" zoomAndPan="magnify" id="Kroki" data-diagram-id="kroki-svg-3"><defs /><g><ellipse cx="675.3723" cy="15" fill="#FFFFFF" rx="10" ry="10" style="stroke:#000000;stroke-width:1;" /><path d="M754.2278,41.8516 L754.2278,57.9844 L734.2278,61.9844 L754.2278,65.9844 L754.2278,82.1172 A0,0 0 0 0 754.2278,82.1172 L947.4143,82.1172 A0,0 0 0 0 947.4143,82.1172 L947.4143,51.8516 L937.4143,41.8516 L754.2278,41.8516 A0,0 0 0 0 754.2278,41.8516" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M937.4143,41.8516 L937.4143,51.8516 L947.4143,51.8516 L937.4143,41.8516" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="146.377" x="760.2278" y="58.9185">Identify attack vectors</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="172.1865" x="760.2278" y="74.0513">and security requirements</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="117.7109" x="616.5168" y="45" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="97.7109" x="626.5168" y="66.1387">Threat Modeling</text><path d="M749.1565,98.9688 L749.1565,115.1016 L729.1565,119.1016 L749.1565,123.1016 L749.1565,139.2344 A0,0 0 0 0 749.1565,139.2344 L914.9275,139.2344 A0,0 0 0 0 914.9275,139.2344 L914.9275,108.9688 L904.9275,98.9688 L749.1565,98.9688 A0,0 0 0 0 749.1565,98.9688" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M904.9275,98.9688 L904.9275,108.9688 L914.9275,108.9688 L904.9275,98.9688" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="80.6914" x="755.1565" y="116.0356">Code review</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="144.771" x="755.1565" y="131.1685">Vulnerability scanning</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="107.5684" x="621.5881" y="102.1172" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="87.5684" x="631.5881" y="123.2559">Static Analysis</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="120.9629" x="614.8909" y="159.2344" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="100.9629" x="624.8909" y="180.373">Dynamic Testing</text><line style="stroke:#000000;stroke-width:1.5;" x1="84.0654" x2="1093.3447" y1="213.2031" y2="213.2031" /><path d="M182.1309,230.0547 L182.1309,246.1875 L162.1309,250.1875 L182.1309,254.1875 L182.1309,270.3203 A0,0 0 0 0 182.1309,270.3203 L343.9473,270.3203 A0,0 0 0 0 343.9473,270.3203 L343.9473,240.0547 L333.9473,230.0547 L182.1309,230.0547 A0,0 0 0 0 182.1309,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M333.9473,230.0547 L333.9473,240.0547 L343.9473,240.0547 L333.9473,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="107.7959" x="188.1309" y="247.1216">Token validation</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="140.8164" x="188.1309" y="262.2544">Session management</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="156.1309" x="6" y="233.2031" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="136.1309" x="16" y="254.3418">Authentication Testing</text><path d="M522.3613,230.0547 L522.3613,246.1875 L502.3613,250.1875 L522.3613,254.1875 L522.3613,270.3203 A0,0 0 0 0 522.3613,270.3203 L669.8193,270.3203 A0,0 0 0 0 669.8193,270.3203 L669.8193,240.0547 L659.8193,230.0547 L522.3613,230.0547 A0,0 0 0 0 522.3613,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M659.8193,230.0547 L659.8193,240.0547 L669.8193,240.0547 L659.8193,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="100.9849" x="528.3613" y="247.1216">Access controls</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="126.458" x="528.3613" y="262.2544">Privilege escalation</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="148.4141" x="353.9473" y="233.2031" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="128.4141" x="363.9473" y="254.3418">Authorization Testing</text><path d="M880.9346,230.0547 L880.9346,246.1875 L860.9346,250.1875 L880.9346,254.1875 L880.9346,270.3203 A0,0 0 0 0 880.9346,270.3203 L1009.375,270.3203 A0,0 0 0 0 1009.375,270.3203 L1009.375,240.0547 L999.375,230.0547 L880.9346,230.0547 A0,0 0 0 0 880.9346,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M999.375,230.0547 L999.375,240.0547 L1009.375,240.0547 L999.375,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="107.4404" x="886.9346" y="247.1216">Injection attacks</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="99.1758" x="886.9346" y="262.2544">Data validation</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="163.1152" x="697.8193" y="233.2031" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="143.1152" x="707.8193" y="254.3418">Input Validation Testing</text><path d="M1187.3145,230.0547 L1187.3145,246.1875 L1167.3145,250.1875 L1187.3145,254.1875 L1187.3145,270.3203 A0,0 0 0 0 1187.3145,270.3203 L1344.7446,270.3203 A0,0 0 0 0 1344.7446,270.3203 L1344.7446,240.0547 L1334.7446,230.0547 L1187.3145,230.0547 A0,0 0 0 0 1187.3145,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M1334.7446,230.0547 L1334.7446,240.0547 L1344.7446,240.0547 L1334.7446,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="97.043" x="1193.3145" y="247.1216">DoS protection</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="136.4302" x="1193.3145" y="262.2544">Resource exhaustion</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="147.9395" x="1019.375" y="233.2031" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="127.9395" x="1029.375" y="254.3418">Rate Limiting Testing</text><line style="stroke:#000000;stroke-width:1.5;" x1="84.0654" x2="1093.3447" y1="290.3203" y2="290.3203" /><path d="M764.1858,307.1719 L764.1858,323.3047 L744.1858,327.3047 L764.1858,331.3047 L764.1858,347.4375 A0,0 0 0 0 764.1858,347.4375 L920.2195,347.4375 A0,0 0 0 0 920.2195,347.4375 L920.2195,317.1719 L910.2195,307.1719 L764.1858,307.1719 A0,0 0 0 0 764.1858,307.1719" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M910.2195,307.1719 L910.2195,317.1719 L920.2195,317.1719 L910.2195,307.1719" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="128.4575" x="770.1858" y="324.2388">Manual exploitation</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="135.0337" x="770.1858" y="339.3716">Real-world scenarios</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="137.627" x="606.5588" y="310.3203" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="117.627" x="616.5588" y="331.459">Penetration Testing</text><path d="M789.1584,364.2891 L789.1584,380.4219 L769.1584,384.4219 L789.1584,388.4219 L789.1584,404.5547 A0,0 0 0 0 789.1584,404.5547 L938.3557,404.5547 A0,0 0 0 0 938.3557,404.5547 L938.3557,374.2891 L928.3557,364.2891 L789.1584,364.2891 A0,0 0 0 0 789.1584,364.2891" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M928.3557,364.2891 L928.3557,374.2891 L938.3557,374.2891 L928.3557,364.2891" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="128.1973" x="795.1584" y="381.356">Automated security</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="60.8169" x="795.1584" y="396.4888">test suite</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="187.5723" x="581.5862" y="367.4375" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="167.5723" x="591.5862" y="388.5762">Security Regression Testing</text><ellipse cx="675.3723" cy="435.5547" fill="none" rx="11" ry="11" style="stroke:#000000;stroke-width:1;" /><ellipse cx="675.3723" cy="435.5547" fill="#FFFFFF" rx="6" ry="6" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="25" y2="45" /><polygon fill="#000000" points="671.3723,35,675.3723,45,679.3723,35,675.3723,39" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="78.9688" y2="102.1172" /><polygon fill="#000000" points="671.3723,92.1172,675.3723,102.1172,679.3723,92.1172,675.3723,96.1172" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="136.0859" y2="159.2344" /><polygon fill="#000000" points="671.3723,149.2344,675.3723,159.2344,679.3723,149.2344,675.3723,153.2344" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="84.0654" x2="84.0654" y1="214.7031" y2="233.2031" /><polygon fill="#000000" points="80.0654,223.2031,84.0654,233.2031,88.0654,223.2031,84.0654,227.2031" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="428.1543" x2="428.1543" y1="214.7031" y2="233.2031" /><polygon fill="#000000" points="424.1543,223.2031,428.1543,233.2031,432.1543,223.2031,428.1543,227.2031" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="779.377" x2="779.377" y1="214.7031" y2="233.2031" /><polygon fill="#000000" points="775.377,223.2031,779.377,233.2031,783.377,223.2031,779.377,227.2031" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="1093.3447" x2="1093.3447" y1="214.7031" y2="233.2031" /><polygon fill="#000000" points="1089.3447,223.2031,1093.3447,233.2031,1097.3447,223.2031,1093.3447,227.2031" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="84.0654" x2="84.0654" y1="267.1719" y2="290.3203" /><polygon fill="#000000" points="80.0654,280.3203,84.0654,290.3203,88.0654,280.3203,84.0654,284.3203" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="428.1543" x2="428.1543" y1="267.1719" y2="290.3203" /><polygon fill="#000000" points="424.1543,280.3203,428.1543,290.3203,432.1543,280.3203,428.1543,284.3203" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="779.377" x2="779.377" y1="267.1719" y2="290.3203" /><polygon fill="#000000" points="775.377,280.3203,779.377,290.3203,783.377,280.3203,779.377,284.3203" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="1093.3447" x2="1093.3447" y1="267.1719" y2="290.3203" /><polygon fill="#000000" points="1089.3447,280.3203,1093.3447,290.3203,1097.3447,280.3203,1093.3447,284.3203" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="193.2031" y2="213.2031" /><polygon fill="#000000" points="671.3723,203.2031,675.3723,213.2031,679.3723,203.2031,675.3723,207.2031" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="291.8203" y2="310.3203" /><polygon fill="#000000" points="671.3723,300.3203,675.3723,310.3203,679.3723,300.3203,675.3723,304.3203" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="344.2891" y2="367.4375" /><polygon fill="#000000" points="671.3723,357.4375,675.3723,367.4375,679.3723,357.4375,675.3723,361.4375" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="401.4063" y2="424.5547" /><polygon fill="#000000" points="671.3723,414.5547,675.3723,424.5547,679.3723,414.5547,675.3723,418.5547" style="stroke:#000000;stroke-width:1;" /></g></svg></p></div></div>
<h3 id="automated-security-testing-framework">Automated Security Testing Framework<a class="headerlink" href="#automated-security-testing-framework" title="Permanent link">&para;</a></h3>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urljoin</span><span class="p">,</span> <span class="n">urlparse</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SecurityTestResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Result of a security test&quot;&quot;&quot;</span>
    <span class="n">test_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">passed</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">severity</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;low&#39;, &#39;medium&#39;, &#39;high&#39;, &#39;critical&#39;</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">remediation</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">APIEndpoint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;API endpoint configuration for testing&quot;&quot;&quot;</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">auth_required</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="n">expected_status</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APISecurityTester</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Comprehensive API security testing framework&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SecurityTestResult</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="c1"># Common payloads for injection testing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_injection_payloads</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;&#39; OR &#39;1&#39;=&#39;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&#39;; DROP TABLE users;--&quot;</span><span class="p">,</span>
            <span class="s2">&quot;1&#39; UNION SELECT NULL,username,password FROM users--&quot;</span><span class="p">,</span>
            <span class="s2">&quot;admin&#39;--&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&#39; OR 1=1#&quot;</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xss_payloads</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;&lt;script&gt;alert(&#39;XSS&#39;)&lt;/script&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;javascript:alert(&#39;XSS&#39;)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&lt;img src=x onerror=alert(&#39;XSS&#39;)&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&#39;;alert(&#39;XSS&#39;);//&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&lt;svg onload=alert(&#39;XSS&#39;)&gt;&quot;</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path_traversal_payloads</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;../../../etc/passwd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;..</span><span class="se">\\</span><span class="s2">..</span><span class="se">\\</span><span class="s2">..</span><span class="se">\\</span><span class="s2">windows</span><span class="se">\\</span><span class="s2">system32</span><span class="se">\\</span><span class="s2">drivers</span><span class="se">\\</span><span class="s2">etc</span><span class="se">\\</span><span class="s2">hosts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;....//....//....//etc/passwd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%2e%2e%2f%2e%2e%2f%2e%2e%2f</span><span class="s2">etc</span><span class="si">%2f</span><span class="s2">passwd&quot;</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">auth_endpoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/auth/login&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Authenticate with the API and store session&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">auth_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">password</span><span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">auth_endpoint</span><span class="p">),</span>
                <span class="n">json</span><span class="o">=</span><span class="n">auth_data</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="c1"># Store authentication token if provided</span>
                <span class="n">auth_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;token&#39;</span> <span class="ow">in</span> <span class="n">auth_data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">auth_data</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">})</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authentication failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_authentication_vulnerabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">APIEndpoint</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SecurityTestResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for authentication vulnerabilities&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">endpoints</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">auth_required</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Test 1: Access without authentication</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_unauthenticated_access</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>

            <span class="c1"># Test 2: Invalid token handling</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_invalid_token</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>

            <span class="c1"># Test 3: Expired token handling</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_token_manipulation</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_test_unauthenticated_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test access to authenticated endpoint without credentials&quot;&quot;&quot;</span>

        <span class="c1"># Remove authentication headers temporarily</span>
        <span class="n">original_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;Authorization&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                <span class="n">params</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
            <span class="p">)</span>

            <span class="c1"># Restore headers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">original_headers</span>

            <span class="c1"># Should return 401 Unauthorized</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                    <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Unauthenticated Access&quot;</span><span class="p">,</span>
                    <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                    <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint properly requires authentication&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">},</span>
                    <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue current authentication enforcement&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                    <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Unauthenticated Access&quot;</span><span class="p">,</span>
                    <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                    <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint accessible without authentication&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                        <span class="s2">&quot;response_size&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                    <span class="p">},</span>
                    <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Implement proper authentication checks&quot;</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Unauthenticated Access&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Error testing unauthenticated access&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Review endpoint implementation&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_test_invalid_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test handling of invalid authentication tokens&quot;&quot;&quot;</span>

        <span class="c1"># Store original authorization</span>
        <span class="n">original_auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Test with invalid token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bearer invalid_token_12345&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                <span class="n">params</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
            <span class="p">)</span>

            <span class="c1"># Restore original authorization</span>
            <span class="k">if</span> <span class="n">original_auth</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_auth</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span>

            <span class="c1"># Should return 401 Unauthorized</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                    <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Invalid Token Handling&quot;</span><span class="p">,</span>
                    <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                    <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Invalid tokens properly rejected&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">},</span>
                    <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue current token validation&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                    <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Invalid Token Handling&quot;</span><span class="p">,</span>
                    <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                    <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Invalid token accepted or poor error handling&quot;</span><span class="p">,</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">},</span>
                    <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Implement proper token validation and error handling&quot;</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Invalid Token Handling&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Error testing invalid token&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Review token validation implementation&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_test_token_manipulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for token manipulation vulnerabilities&quot;&quot;&quot;</span>

        <span class="n">original_auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Test various token manipulations</span>
        <span class="n">manipulated_tokens</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;Bearer &#39;</span><span class="p">,</span>  <span class="c1"># Empty token</span>
            <span class="s1">&#39;Bearer null&#39;</span><span class="p">,</span>  <span class="c1"># Null token</span>
            <span class="s1">&#39;Bearer eyJhbGciOiJub25lIn0.eyJzdWIiOiJhZG1pbiJ9.&#39;</span><span class="p">,</span>  <span class="c1"># None algorithm JWT</span>
            <span class="s1">&#39;Basic YWRtaW46YWRtaW4=&#39;</span><span class="p">,</span>  <span class="c1"># Different auth scheme</span>
        <span class="p">]</span>

        <span class="n">vulnerabilities_found</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">manipulated_tokens</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                    <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">401</span><span class="p">:</span>
                    <span class="n">vulnerabilities_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
                        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
                    <span class="p">})</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Restore original authorization</span>
        <span class="k">if</span> <span class="n">original_auth</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_auth</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vulnerabilities_found</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Token Manipulation&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Token manipulation attempts properly blocked&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;manipulations_tested&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">manipulated_tokens</span><span class="p">)},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue current token validation&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Token Manipulation&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Vulnerable to token manipulation&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vulnerabilities&quot;</span><span class="p">:</span> <span class="n">vulnerabilities_found</span><span class="p">},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Implement stronger token validation and proper error handling&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_injection_vulnerabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">APIEndpoint</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SecurityTestResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for injection vulnerabilities&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">endpoints</span><span class="p">:</span>
            <span class="c1"># Test SQL injection</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_sql_injection</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>

            <span class="c1"># Test XSS</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_xss_injection</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>

            <span class="c1"># Test path traversal</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_path_traversal</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_test_sql_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for SQL injection vulnerabilities&quot;&quot;&quot;</span>

        <span class="n">vulnerabilities_found</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">payload</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_injection_payloads</span><span class="p">:</span>
            <span class="c1"># Test in different parameter positions</span>
            <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">test_params</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">test_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                        <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                        <span class="n">params</span><span class="o">=</span><span class="n">test_params</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">json</span><span class="o">=</span><span class="n">test_params</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
                    <span class="p">)</span>

                    <span class="c1"># Look for SQL error indicators</span>
                    <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">sql_errors</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s1">&#39;sql syntax&#39;</span><span class="p">,</span> <span class="s1">&#39;mysql_fetch&#39;</span><span class="p">,</span> <span class="s1">&#39;ora-&#39;</span><span class="p">,</span> <span class="s1">&#39;postgresql&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;sqlite_&#39;</span><span class="p">,</span> <span class="s1">&#39;database error&#39;</span><span class="p">,</span> <span class="s1">&#39;sql statement&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;syntax error&#39;</span><span class="p">,</span> <span class="s1">&#39;table does not exist&#39;</span>
                    <span class="p">]</span>

                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">error</span> <span class="ow">in</span> <span class="n">response_text</span> <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">sql_errors</span><span class="p">):</span>
                        <span class="n">vulnerabilities_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_name</span><span class="p">,</span>
                            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
                            <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                            <span class="s1">&#39;error_indicators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">err</span> <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">sql_errors</span> <span class="k">if</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">response_text</span><span class="p">]</span>
                        <span class="p">})</span>

                    <span class="c1"># Also check for unusual response times (blind SQL injection)</span>
                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">vulnerabilities_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_name</span><span class="p">,</span>
                            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;time_based_blind&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;response_time&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                        <span class="p">})</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Connection errors might indicate successful injection</span>
                    <span class="k">if</span> <span class="s1">&#39;timeout&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">vulnerabilities_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_name</span><span class="p">,</span>
                            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;timeout&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vulnerabilities_found</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;SQL Injection&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;critical&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;No SQL injection vulnerabilities detected&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;payloads_tested&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_injection_payloads</span><span class="p">)},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue using parameterized queries&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;SQL Injection&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;critical&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;SQL injection vulnerability detected&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vulnerabilities&quot;</span><span class="p">:</span> <span class="n">vulnerabilities_found</span><span class="p">},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Use parameterized queries and input validation&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_test_xss_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for XSS vulnerabilities&quot;&quot;&quot;</span>

        <span class="n">vulnerabilities_found</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">payload</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xss_payloads</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">test_params</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">test_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                        <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                        <span class="n">params</span><span class="o">=</span><span class="n">test_params</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">json</span><span class="o">=</span><span class="n">test_params</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
                    <span class="p">)</span>

                    <span class="c1"># Check if payload is reflected in response</span>
                    <span class="k">if</span> <span class="n">payload</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                        <span class="n">vulnerabilities_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_name</span><span class="p">,</span>
                            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;reflected_xss&#39;</span>
                        <span class="p">})</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vulnerabilities_found</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Cross-Site Scripting (XSS)&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;No XSS vulnerabilities detected&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;payloads_tested&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xss_payloads</span><span class="p">)},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue proper output encoding&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Cross-Site Scripting (XSS)&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;XSS vulnerability detected&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vulnerabilities&quot;</span><span class="p">:</span> <span class="n">vulnerabilities_found</span><span class="p">},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Implement proper input validation and output encoding&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_test_path_traversal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for path traversal vulnerabilities&quot;&quot;&quot;</span>

        <span class="n">vulnerabilities_found</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">payload</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_traversal_payloads</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">test_params</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">test_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                        <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                        <span class="n">params</span><span class="o">=</span><span class="n">test_params</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">json</span><span class="o">=</span><span class="n">test_params</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
                    <span class="p">)</span>

                    <span class="c1"># Look for system file indicators</span>
                    <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">system_indicators</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s1">&#39;root:&#39;</span><span class="p">,</span> <span class="s1">&#39;bin/bash&#39;</span><span class="p">,</span> <span class="s1">&#39;windows</span><span class="se">\\</span><span class="s1">system32&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;/etc/passwd&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1&#39;</span>
                    <span class="p">]</span>

                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">indicator</span> <span class="ow">in</span> <span class="n">response_text</span> <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">system_indicators</span><span class="p">):</span>
                        <span class="n">vulnerabilities_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_name</span><span class="p">,</span>
                            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
                            <span class="s1">&#39;indicators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">ind</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">system_indicators</span> <span class="k">if</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">response_text</span><span class="p">]</span>
                        <span class="p">})</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vulnerabilities_found</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Path Traversal&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;No path traversal vulnerabilities detected&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;payloads_tested&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_traversal_payloads</span><span class="p">)},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue proper file path validation&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Path Traversal&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Path traversal vulnerability detected&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vulnerabilities&quot;</span><span class="p">:</span> <span class="n">vulnerabilities_found</span><span class="p">},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Implement proper file path validation and sandboxing&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_rate_limiting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">,</span> 
                          <span class="n">requests_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> 
                          <span class="n">time_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test rate limiting implementation&quot;&quot;&quot;</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">status_codes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">response_times</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Send rapid requests</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">requests_count</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">request_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                    <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                    <span class="n">params</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">json</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
                <span class="p">)</span>
                <span class="n">request_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">request_start</span>

                <span class="n">status_codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
                <span class="n">response_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request_time</span><span class="p">)</span>

                <span class="c1"># Short delay to avoid overwhelming the server</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">status_codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Connection error</span>
                <span class="n">response_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

        <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="c1"># Analyze results</span>
        <span class="n">rate_limited_responses</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">status_codes</span> <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">)</span>
        <span class="n">successful_responses</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">status_codes</span> <span class="k">if</span> <span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rate_limited_responses</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Rate Limiting&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Rate limiting is implemented&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;total_requests&quot;</span><span class="p">:</span> <span class="n">requests_count</span><span class="p">,</span>
                    <span class="s2">&quot;rate_limited&quot;</span><span class="p">:</span> <span class="n">rate_limited_responses</span><span class="p">,</span>
                    <span class="s2">&quot;successful&quot;</span><span class="p">:</span> <span class="n">successful_responses</span><span class="p">,</span>
                    <span class="s2">&quot;total_time&quot;</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
                    <span class="s2">&quot;avg_response_time&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">response_times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">response_times</span><span class="p">)</span>
                <span class="p">},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue current rate limiting implementation&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Rate Limiting&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;No rate limiting detected&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;total_requests&quot;</span><span class="p">:</span> <span class="n">requests_count</span><span class="p">,</span>
                    <span class="s2">&quot;successful&quot;</span><span class="p">:</span> <span class="n">successful_responses</span><span class="p">,</span>
                    <span class="s2">&quot;total_time&quot;</span><span class="p">:</span> <span class="n">total_time</span>
                <span class="p">},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Implement rate limiting to prevent abuse&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_cors_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test CORS configuration security&quot;&quot;&quot;</span>

        <span class="n">cors_issues</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Test with malicious origin</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Origin&#39;</span><span class="p">:</span> <span class="s1">&#39;https://evil.com&#39;</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
            <span class="p">)</span>

            <span class="n">cors_origin</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">cors_credentials</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Credentials&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="c1"># Check for overly permissive CORS</span>
            <span class="k">if</span> <span class="n">cors_origin</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span> <span class="ow">and</span> <span class="n">cors_credentials</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">cors_issues</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;issue&#39;</span><span class="p">:</span> <span class="s1">&#39;Wildcard origin with credentials&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span>
                <span class="p">})</span>

            <span class="k">if</span> <span class="n">cors_origin</span> <span class="o">==</span> <span class="s1">&#39;https://evil.com&#39;</span><span class="p">:</span>
                <span class="n">cors_issues</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;issue&#39;</span><span class="p">:</span> <span class="s1">&#39;Malicious origin accepted&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span>
                <span class="p">})</span>

            <span class="c1"># Test preflight request</span>
            <span class="n">preflight_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;Origin&#39;</span><span class="p">:</span> <span class="s1">&#39;https://evil.com&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Access-Control-Request-Method&#39;</span><span class="p">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Access-Control-Request-Headers&#39;</span><span class="p">:</span> <span class="s1">&#39;Content-Type&#39;</span>
                <span class="p">},</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">preflight_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">allowed_methods</span> <span class="o">=</span> <span class="n">preflight_response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;DELETE&#39;</span> <span class="ow">in</span> <span class="n">allowed_methods</span> <span class="ow">or</span> <span class="s1">&#39;PUT&#39;</span> <span class="ow">in</span> <span class="n">allowed_methods</span><span class="p">:</span>
                    <span class="n">cors_issues</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;issue&#39;</span><span class="p">:</span> <span class="s1">&#39;Dangerous methods allowed in CORS&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;methods&#39;</span><span class="p">:</span> <span class="n">allowed_methods</span><span class="p">,</span>
                        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span>
                    <span class="p">})</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">cors_issues</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;issue&#39;</span><span class="p">:</span> <span class="s1">&#39;Error testing CORS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span>
            <span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cors_issues</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;CORS Configuration&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;CORS configuration appears secure&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cors_headers&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">)},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue current CORS policy&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;CORS Configuration&quot;</span><span class="p">,</span>
                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;CORS configuration issues detected&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="n">cors_issues</span><span class="p">},</span>
                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Review and tighten CORS policy&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_security_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate comprehensive security test report&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No test results available&quot;</span><span class="p">}</span>

        <span class="c1"># Categorize results</span>
        <span class="n">passed_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">passed</span><span class="p">]</span>
        <span class="n">failed_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">passed</span><span class="p">]</span>

        <span class="c1"># Count by severity</span>
        <span class="n">severity_counts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="s1">&#39;critical&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="s1">&#39;medium&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span><span class="p">])</span>
        <span class="p">}</span>

        <span class="c1"># Calculate security score</span>
        <span class="n">total_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
        <span class="n">security_score</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">passed_tests</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_tests</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">total_tests</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;total_tests&#39;</span><span class="p">:</span> <span class="n">total_tests</span><span class="p">,</span>
                <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed_tests</span><span class="p">),</span>
                <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_tests</span><span class="p">),</span>
                <span class="s1">&#39;security_score&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">security_score</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="s1">&#39;severity_breakdown&#39;</span><span class="p">:</span> <span class="n">severity_counts</span><span class="p">,</span>
            <span class="s1">&#39;failed_tests&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">test</span><span class="o">.</span><span class="n">test_name</span><span class="p">,</span>
                    <span class="s1">&#39;endpoint&#39;</span><span class="p">:</span> <span class="n">test</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span>
                    <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="n">test</span><span class="o">.</span><span class="n">severity</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">test</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="s1">&#39;remediation&#39;</span><span class="p">:</span> <span class="n">test</span><span class="o">.</span><span class="n">remediation</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">failed_tests</span>
            <span class="p">],</span>
            <span class="s1">&#39;recommendations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_recommendations</span><span class="p">(</span><span class="n">failed_tests</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failed_tests</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SecurityTestResult</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate security recommendations based on test results&quot;&quot;&quot;</span>

        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check for critical issues</span>
        <span class="n">critical_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="s1">&#39;critical&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">critical_tests</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;CRITICAL: Address SQL injection vulnerabilities immediately using parameterized queries&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check for authentication issues</span>
        <span class="n">auth_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="s1">&#39;authentication&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">test_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">auth_tests</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;Strengthen authentication mechanisms and token validation&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check for injection issues</span>
        <span class="n">injection_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">word</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">test_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;injection&#39;</span><span class="p">,</span> <span class="s1">&#39;xss&#39;</span><span class="p">,</span> <span class="s1">&#39;traversal&#39;</span><span class="p">]</span>
        <span class="p">)]</span>
        <span class="k">if</span> <span class="n">injection_tests</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;Implement comprehensive input validation and output encoding&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check for CORS issues</span>
        <span class="n">cors_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="s1">&#39;cors&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">test_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">cors_tests</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;Review and tighten CORS policies to prevent cross-origin attacks&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">recommendations</span>

<span class="k">def</span><span class="w"> </span><span class="nf">security_testing_example</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate API security testing&quot;&quot;&quot;</span>

    <span class="c1"># Initialize security tester</span>
    <span class="n">tester</span> <span class="o">=</span> <span class="n">APISecurityTester</span><span class="p">(</span><span class="s2">&quot;https://api.example.com&quot;</span><span class="p">)</span>

    <span class="c1"># Define test endpoints</span>
    <span class="n">test_endpoints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">APIEndpoint</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/users&quot;</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
            <span class="n">auth_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">},</span>
            <span class="n">expected_status</span><span class="o">=</span><span class="mi">200</span>
        <span class="p">),</span>
        <span class="n">APIEndpoint</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/users&quot;</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
            <span class="n">auth_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&quot;</span><span class="p">},</span>
            <span class="n">expected_status</span><span class="o">=</span><span class="mi">201</span>
        <span class="p">),</span>
        <span class="n">APIEndpoint</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/files&quot;</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
            <span class="n">auth_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;document.pdf&quot;</span><span class="p">},</span>
            <span class="n">expected_status</span><span class="o">=</span><span class="mi">200</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Authenticate (if needed)</span>
    <span class="k">if</span> <span class="n">tester</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="s2">&quot;testpass&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Authentication successful&quot;</span><span class="p">)</span>

    <span class="c1"># Run security tests</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running authentication tests...&quot;</span><span class="p">)</span>
    <span class="n">auth_results</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">test_authentication_vulnerabilities</span><span class="p">(</span><span class="n">test_endpoints</span><span class="p">)</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">auth_results</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running injection tests...&quot;</span><span class="p">)</span>
    <span class="n">injection_results</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">test_injection_vulnerabilities</span><span class="p">(</span><span class="n">test_endpoints</span><span class="p">)</span>
    <span class="n">tester</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">injection_results</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running rate limiting tests...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">test_endpoints</span><span class="p">:</span>
        <span class="n">rate_result</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">test_rate_limiting</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">tester</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rate_result</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running CORS tests...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">test_endpoints</span><span class="p">:</span>
        <span class="n">cors_result</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">test_cors_configuration</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">tester</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cors_result</span><span class="p">)</span>

    <span class="c1"># Generate report</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">generate_security_report</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Security Test Report:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Security Score: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;security_score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tests Passed: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;total_tests&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;failed_tests&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed Tests:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;failed_tests&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recommendations:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">security_testing_example</span><span class="p">()</span>
</code></pre>
</div>
<h2 id="building-a-complete-secure-rest-api">Building a Complete Secure REST API<a class="headerlink" href="#building-a-complete-secure-rest-api" title="Permanent link">&para;</a></h2>
<p>Now we&rsquo;ll integrate all the security concepts covered into a complete, production-ready REST API with comprehensive security features.</p>
<h3 id="secure-api-architecture">Secure API Architecture<a class="headerlink" href="#secure-api-architecture" title="Permanent link">&para;</a></h3>
<div class="diagram-container" data-container-id="kroki-diagram-4"><button class="diagram-expand-btn" onclick="openDiagramModal('kroki-diagram-4')">🔍 View Larger</button><div id="kroki-diagram-4" class="diagram-content"><p><svg xmlns="http://www.w3.org/2000/svg" contentStyleType="text/css" data-diagram-type="DESCRIPTION" height="798px" preserveAspectRatio="xMaxYMax meet" style="width:596px;height:798px;background:#FFFFFF;" version="1.1" viewBox="0 0 596 798" width="596px" zoomAndPan="magnify" id="Kroki" data-diagram-id="kroki-svg-4"><defs /><g><g class="cluster" data-entity="Client Layer" data-source-line="5" data-uid="ent0002" id="cluster_Client Layer"><path d="M14.5,11 L110.2939,11 A3.75,3.75 0 0 1 112.7939,13.5 L119.7939,33.2969 L482.5,33.2969 A2.5,2.5 0 0 1 485,35.7969 L485,105.8 A2.5,2.5 0 0 1 482.5,108.3 L14.5,108.3 A2.5,2.5 0 0 1 12,105.8 L12,13.5 A2.5,2.5 0 0 1 14.5,11" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="12" x2="119.7939" y1="33.2969" y2="33.2969" /><text fill="#000000" font-family="Arial" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="94.7939" x="16" y="25.9951">Client Layer</text></g><g class="cluster" data-entity="Security Layer" data-source-line="11" data-uid="ent0006" id="cluster_Security Layer"><path d="M186.5,132.3 L301.6328,132.3 A3.75,3.75 0 0 1 304.1328,134.8 L311.1328,154.5969 L357.5,154.5969 A2.5,2.5 0 0 1 360,157.0969 L360,545.99 A2.5,2.5 0 0 1 357.5,548.49 L186.5,548.49 A2.5,2.5 0 0 1 184,545.99 L184,134.8 A2.5,2.5 0 0 1 186.5,132.3" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="184" x2="311.1328" y1="154.5969" y2="154.5969" /><text fill="#000000" font-family="Arial" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="114.1328" x="188" y="147.2951">Security Layer</text></g><g class="cluster" data-entity="API Layer" data-source-line="18" data-uid="ent0011" id="cluster_API Layer"><path d="M13.5,572.49 L89.5723,572.49 A3.75,3.75 0 0 1 92.0723,574.99 L99.0723,594.7869 L537.5,594.7869 A2.5,2.5 0 0 1 540,597.2869 L540,667.28 A2.5,2.5 0 0 1 537.5,669.78 L13.5,669.78 A2.5,2.5 0 0 1 11,667.28 L11,574.99 A2.5,2.5 0 0 1 13.5,572.49" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="11" x2="99.0723" y1="594.7869" y2="594.7869" /><text fill="#000000" font-family="Arial" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="75.0723" x="15" y="587.4851">API Layer</text></g><g class="cluster" data-entity="Data Layer" data-source-line="24" data-uid="ent0015" id="cluster_Data Layer"><path d="M44.5,693.78 L131.4756,693.78 A3.75,3.75 0 0 1 133.9756,696.28 L140.9756,716.0769 L586.5,716.0769 A2.5,2.5 0 0 1 589,718.5769 L589,788.58 A2.5,2.5 0 0 1 586.5,791.08 L44.5,791.08 A2.5,2.5 0 0 1 42,788.58 L42,696.28 A2.5,2.5 0 0 1 44.5,693.78" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="42" x2="140.9756" y1="716.0769" y2="716.0769" /><text fill="#000000" font-family="Arial" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="85.9756" x="46" y="708.7751">Data Layer</text></g><g class="entity" data-entity="Web App" data-source-line="6" data-uid="ent0003" id="entity_Web App"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="103.1436" x="365.43" y="46" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="448.5736" y="51" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="446.5736" y="53" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="446.5736" y="57" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="63.1436" x="380.43" y="78.9951">Web App</text></g><g class="entity" data-entity="Mobile App" data-source-line="7" data-uid="ent0004" id="entity_Mobile App"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="117.7246" x="213.14" y="46" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="310.8646" y="51" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="308.8646" y="53" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="308.8646" y="57" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="77.7246" x="228.14" y="78.9951">Mobile App</text></g><g class="entity" data-entity="Third-party App" data-source-line="8" data-uid="ent0005" id="entity_Third-party App"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="149.8057" x="28.1" y="46" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="157.9057" y="51" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="155.9057" y="53" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="155.9057" y="57" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="109.8057" x="43.1" y="78.9951">Third-party App</text></g><g class="entity" data-entity="RL" data-source-line="12" data-uid="ent0007" id="entity_RL"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="125.9346" x="209.03" y="167.3" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="314.9646" y="172.3" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="312.9646" y="174.3" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="312.9646" y="178.3" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="85.9346" x="224.03" y="200.2951">Rate Limiter</text></g><g class="entity" data-entity="CORS" data-source-line="13" data-uid="ent0008" id="entity_CORS"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="138.9844" x="202.51" y="273.6" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="321.4944" y="278.6" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="319.4944" y="280.6" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="319.4944" y="284.6" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="98.9844" x="217.51" y="306.5951">CORS Handler</text></g><g class="entity" data-entity="Auth" data-source-line="14" data-uid="ent0009" id="entity_Auth"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="142.7715" x="200.61" y="379.89" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="323.3815" y="384.89" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="321.3815" y="386.89" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="321.3815" y="390.89" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="102.7715" x="215.61" y="412.8851">Authentication</text></g><g class="entity" data-entity="Validator" data-source-line="15" data-uid="ent0010" id="entity_Validator"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="143.9131" x="200.04" y="486.19" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="323.9531" y="491.19" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="321.9531" y="493.19" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="321.9531" y="497.19" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="103.9131" x="215.04" y="519.1851">Input Validator</text></g><g class="entity" data-entity="User Controller" data-source-line="19" data-uid="ent0012" id="entity_User Controller"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="145.5332" x="378.23" y="607.49" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="503.7632" y="612.49" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="501.7632" y="614.49" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="501.7632" y="618.49" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="105.5332" x="393.23" y="640.4851">User Controller</text></g><g class="entity" data-entity="Post Controller" data-source-line="20" data-uid="ent0013" id="entity_Post Controller"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="143.4141" x="200.29" y="607.49" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="323.7041" y="612.49" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="321.7041" y="614.49" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="321.7041" y="618.49" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="103.4141" x="215.29" y="640.4851">Post Controller</text></g><g class="entity" data-entity="File Controller" data-source-line="21" data-uid="ent0014" id="entity_File Controller"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="138.0684" x="26.97" y="607.49" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="145.0384" y="612.49" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="143.0384" y="614.49" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="143.0384" y="618.49" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="98.0684" x="41.97" y="640.4851">File Controller</text></g><g class="entity" data-entity="Session Store" data-source-line="25" data-uid="ent0016" id="entity_Session Store"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="135.1768" x="437.41" y="728.78" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="552.5868" y="733.78" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="550.5868" y="735.78" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="550.5868" y="739.78" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="95.1768" x="452.41" y="761.7751">Session Store</text></g><g class="entity" data-entity="User Database" data-source-line="26" data-uid="ent0017" id="entity_User Database"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="143.1611" x="259.42" y="728.78" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="382.5811" y="733.78" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="380.5811" y="735.78" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="380.5811" y="739.78" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="103.1611" x="274.42" y="761.7751">User Database</text></g><g class="entity" data-entity="Content Database" data-source-line="27" data-uid="ent0018" id="entity_Content Database"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="166.9297" x="57.54" y="728.78" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="204.4697" y="733.78" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="202.4697" y="735.78" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="202.4697" y="739.78" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="126.9297" x="72.54" y="761.7751">Content Database</text></g><g class="link" data-entity-1="Web App" data-entity-2="RL" data-source-line="30" data-uid="lnk19" id="link_Web App_RL"><path d="M389.73,92.59 C363.8,113.92 329.6627,141.9971 303.7827,163.2971" fill="none" id="Web App-to-RL" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="299.15,167.11,308.641,164.4792,303.0106,163.9326,303.5572,158.3022,299.15,167.11" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Mobile App" data-entity-2="RL" data-source-line="31" data-uid="lnk20" id="link_Mobile App_RL"><path d="M272,92.59 C272,113.92 272,139.81 272,161.11" fill="none" id="Mobile App-to-RL" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="272,167.11,276,158.11,272,162.11,268,158.11,272,167.11" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Third-party App" data-entity-2="RL" data-source-line="32" data-uid="lnk21" id="link_Third-party App_RL"><path d="M134.79,92.59 C164.91,113.85 204.9985,142.1495 235.1685,163.4495" fill="none" id="Third-party App-to-RL" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="240.07,166.91,235.0247,158.4516,235.9854,164.0263,230.4107,164.987,240.07,166.91" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="RL" data-entity-2="CORS" data-source-line="34" data-uid="lnk22" id="link_RL_CORS"><path d="M272,214.08 C272,231.57 272,249.67 272,267.16" fill="none" id="RL-to-CORS" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="272,273.16,276,264.16,272,268.16,268,264.16,272,273.16" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="CORS" data-entity-2="Auth" data-source-line="35" data-uid="lnk23" id="link_CORS_Auth"><path d="M272,320.37 C272,337.87 272,355.97 272,373.45" fill="none" id="CORS-to-Auth" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="272,379.45,276,370.45,272,374.45,268,370.45,272,379.45" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Auth" data-entity-2="Validator" data-source-line="36" data-uid="lnk24" id="link_Auth_Validator"><path d="M272,426.67 C272,444.17 272,462.27 272,479.75" fill="none" id="Auth-to-Validator" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="272,485.75,276,476.75,272,480.75,268,476.75,272,485.75" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Validator" data-entity-2="User Controller" data-source-line="37" data-uid="lnk25" id="link_Validator_User Controller"><path d="M310.53,532.86 C326.35,542.35 344.73,553.67 361,564.49 C381.4,578.05 398.8893,590.6177 416.1893,603.4377" fill="none" id="Validator-to-User Controller" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="421.01,607.01,416.1606,598.4378,416.9928,604.0331,411.3975,604.8653,421.01,607.01" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Validator" data-entity-2="Post Controller" data-source-line="38" data-uid="lnk26" id="link_Validator_Post Controller"><path d="M272,532.78 C272,554.11 272,580 272,601.3" fill="none" id="Validator-to-Post Controller" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="272,607.3,276,598.3,272,602.3,268,598.3,272,607.3" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Validator" data-entity-2="File Controller" data-source-line="39" data-uid="lnk27" id="link_Validator_File Controller"><path d="M233.38,532.73 C217.55,542.2 199.18,553.54 183,564.49 C162.99,578.02 145.9923,590.6372 129.2423,603.5472" fill="none" id="Validator-to-File Controller" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="124.49,607.21,134.0603,604.884,128.4502,604.1577,129.1765,598.5476,124.49,607.21" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="User Controller" data-entity-2="Session Store" data-source-line="41" data-uid="lnk28" id="link_User Controller_Session Store"><path d="M461.16,654.07 C470.81,675.4 482.7751,701.8342 492.4151,723.1242" fill="none" id="User Controller-to-Session Store" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="494.89,728.59,494.8215,718.7414,492.8276,724.0352,487.5338,722.0412,494.89,728.59" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="User Controller" data-entity-2="User Database" data-source-line="42" data-uid="lnk29" id="link_User Controller_User Database"><path d="M428.43,654.07 C406.97,675.4 379.1455,703.0703 357.7255,724.3603" fill="none" id="User Controller-to-User Database" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="353.47,728.59,362.6731,725.0825,357.0163,725.0652,357.0335,719.4084,353.47,728.59" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Post Controller" data-entity-2="Content Database" data-source-line="43" data-uid="lnk30" id="link_Post Controller_Content Database"><path d="M247.36,654.07 C223.94,675.4 193.3463,703.2603 169.9663,724.5503" fill="none" id="Post Controller-to-Content Database" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="165.53,728.59,174.8776,725.4879,169.2269,725.2236,169.4913,719.5729,165.53,728.59" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="File Controller" data-entity-2="Content Database" data-source-line="44" data-uid="lnk31" id="link_File Controller_Content Database"><path d="M104.46,654.07 C112.51,675.4 122.4226,701.686 130.4526,722.976" fill="none" id="File Controller-to-Content Database" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="132.57,728.59,133.1365,718.7574,130.8055,723.9117,125.6512,721.5807,132.57,728.59" style="stroke:#000000;stroke-width:1;" /></g></g></svg></p></div></div>
<h3 id="complete-secure-api-implementation">Complete Secure API Implementation<a class="headerlink" href="#complete-secure-api-implementation" title="Permanent link">&para;</a></h3>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_password_hash</span><span class="p">,</span> <span class="n">check_password_hash</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>

<span class="c1"># Import our security components</span>
<span class="c1"># (In a real application, these would be in separate modules)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SecureTaskAPI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Complete secure REST API for task management&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

        <span class="c1"># Initialize security components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span> <span class="o">=</span> <span class="n">JWTManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span> <span class="o">=</span> <span class="n">CORSManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_manager</span> <span class="o">=</span> <span class="n">SecureSessionManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">security_tester</span> <span class="o">=</span> <span class="n">APISecurityTester</span><span class="p">(</span><span class="s2">&quot;http://localhost:5000&quot;</span><span class="p">)</span>

        <span class="c1"># Setup database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_database</span><span class="p">()</span>

        <span class="c1"># Configure CORS policies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_cors_policies</span><span class="p">()</span>

        <span class="c1"># Setup rate limiting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_rate_limiting</span><span class="p">()</span>

        <span class="c1"># Register routes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_routes</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize SQLite database with secure schema&quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;secure_tasks.db&#39;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># Users table with security features</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            CREATE TABLE IF NOT EXISTS users (</span>
<span class="s1">                id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s1">                username TEXT UNIQUE NOT NULL,</span>
<span class="s1">                email TEXT UNIQUE NOT NULL,</span>
<span class="s1">                password_hash TEXT NOT NULL,</span>
<span class="s1">                salt TEXT NOT NULL,</span>
<span class="s1">                is_active BOOLEAN DEFAULT 1,</span>
<span class="s1">                failed_login_attempts INTEGER DEFAULT 0,</span>
<span class="s1">                last_failed_login TIMESTAMP,</span>
<span class="s1">                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
<span class="s1">            )</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Tasks table</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            CREATE TABLE IF NOT EXISTS tasks (</span>
<span class="s1">                id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s1">                user_id INTEGER NOT NULL,</span>
<span class="s1">                title TEXT NOT NULL,</span>
<span class="s1">                description TEXT,</span>
<span class="s1">                status TEXT DEFAULT &#39;pending&#39;,</span>
<span class="s1">                priority INTEGER DEFAULT 1,</span>
<span class="s1">                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                FOREIGN KEY (user_id) REFERENCES users (id)</span>
<span class="s1">            )</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># API keys table</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            CREATE TABLE IF NOT EXISTS api_keys (</span>
<span class="s1">                id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s1">                key_id TEXT UNIQUE NOT NULL,</span>
<span class="s1">                key_hash TEXT NOT NULL,</span>
<span class="s1">                user_id INTEGER NOT NULL,</span>
<span class="s1">                name TEXT NOT NULL,</span>
<span class="s1">                permissions TEXT NOT NULL,</span>
<span class="s1">                is_active BOOLEAN DEFAULT 1,</span>
<span class="s1">                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                expires_at TIMESTAMP,</span>
<span class="s1">                FOREIGN KEY (user_id) REFERENCES users (id)</span>
<span class="s1">            )</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_cors_policies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure CORS policies for different environments&quot;&quot;&quot;</span>

        <span class="c1"># Development policy</span>
        <span class="n">dev_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">create_secure_policy</span><span class="p">(</span>
            <span class="n">allowed_origins</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;http://localhost:3000&#39;</span><span class="p">,</span> <span class="s1">&#39;http://127.0.0.1:3000&#39;</span><span class="p">],</span>
            <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Production policy</span>
        <span class="n">prod_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">create_secure_policy</span><span class="p">(</span>
            <span class="n">allowed_origins</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;https://taskapp.com&#39;</span><span class="p">,</span> <span class="s1">&#39;https://api.taskapp.com&#39;</span><span class="p">],</span>
            <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="s1">&#39;development&#39;</span><span class="p">,</span> <span class="n">dev_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="n">prod_policy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">set_default_policy</span><span class="p">(</span><span class="n">dev_policy</span><span class="p">)</span>  <span class="c1"># Use dev for demo</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_rate_limiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure rate limiting for different endpoints&quot;&quot;&quot;</span>

        <span class="c1"># Different limits for different endpoint types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">create_rate_limit</span><span class="p">(</span><span class="s1">&#39;auth_endpoint&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>      <span class="c1"># 5 req/sec, burst 50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">create_rate_limit</span><span class="p">(</span><span class="s1">&#39;api_endpoint&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>     <span class="c1"># 50 req/sec, burst 500</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">create_rate_limit</span><span class="p">(</span><span class="s1">&#39;public_endpoint&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># 10 req/sec, burst 100</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_db_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get database connection with security considerations&quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;secure_tasks.db&#39;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>  <span class="c1"># Enable column access by name</span>

        <span class="c1"># Enable foreign key constraints</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA foreign_keys = ON&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">conn</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">rules</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Comprehensive input validation&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="c1"># Required field check</span>
            <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> is required&quot;</span>
                <span class="k">continue</span>

            <span class="c1"># Type validation</span>
            <span class="n">expected_type</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">expected_type</span><span class="p">):</span>
                <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> must be of type </span><span class="si">{</span><span class="n">expected_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">continue</span>

            <span class="c1"># Length validation</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">min_length</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_length&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">max_length</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_length&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_length</span><span class="p">:</span>
                    <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> must be at least </span><span class="si">{</span><span class="n">min_length</span><span class="si">}</span><span class="s2"> characters&quot;</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
                    <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> must be at most </span><span class="si">{</span><span class="n">max_length</span><span class="si">}</span><span class="s2"> characters&quot;</span>
                    <span class="k">continue</span>

            <span class="c1"># Pattern validation (regex)</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pattern&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pattern</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                    <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> format is invalid&quot;</span>
                    <span class="k">continue</span>

            <span class="c1"># Custom validation function</span>
            <span class="n">validator</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validator&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">validator</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">validator</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> validation failed&quot;</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">errors</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sanitize input data to prevent injection attacks&quot;&quot;&quot;</span>
        <span class="n">sanitized</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># Remove potential SQL injection characters</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span>  <span class="c1"># Escape single quotes</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[&lt;&gt;&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># Remove XSS characters</span>

                <span class="c1"># Limit length to prevent buffer overflow</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>

                <span class="n">sanitized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sanitized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">sanitized</span>

    <span class="c1"># Security decorators</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">require_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permissions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator for endpoints requiring authentication&quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="c1"># Check rate limiting first</span>
                <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>
                <span class="n">allowed</span><span class="p">,</span> <span class="n">rate_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">is_allowed</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;auth_</span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Rate limit exceeded&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;retry_after&#39;</span><span class="p">:</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;retry_after&#39;</span><span class="p">]</span>
                    <span class="p">}),</span> <span class="mi">429</span>

                <span class="c1"># Get token from header</span>
                <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Missing or invalid authorization header&#39;</span><span class="p">}),</span> <span class="mi">401</span>

                <span class="n">token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="c1"># Validate JWT token</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid or expired token&#39;</span><span class="p">}),</span> <span class="mi">401</span>

                <span class="c1"># Check permissions</span>
                <span class="k">if</span> <span class="n">permissions</span><span class="p">:</span>
                    <span class="n">user_permissions</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permissions&#39;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">perm</span> <span class="ow">in</span> <span class="n">user_permissions</span> <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">permissions</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient permissions&#39;</span><span class="p">}),</span> <span class="mi">403</span>

                <span class="c1"># Store user info for use in endpoint</span>
                <span class="n">g</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">payload</span>

                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">decorated_function</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">require_cors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator for CORS handling&quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="c1"># Handle preflight requests</span>
                <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
                    <span class="n">cors_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">handle_preflight_request</span><span class="p">(</span>
                        <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Access-Control-Request-Method&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                        <span class="n">headers</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Access-Control-Request-Headers&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span>
                        <span class="n">policy_name</span><span class="o">=</span><span class="n">policy_name</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cors_headers</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;CORS policy violation&#39;</span><span class="p">}),</span> <span class="mi">403</span>

                    <span class="n">response</span> <span class="o">=</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;preflight ok&#39;</span><span class="p">})</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cors_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                    <span class="k">return</span> <span class="n">response</span>

                <span class="c1"># Handle actual request</span>
                <span class="n">cors_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">handle_actual_request</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">cors_headers</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;CORS policy violation&#39;</span><span class="p">}),</span> <span class="mi">403</span>

                <span class="c1"># Execute the actual function</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="c1"># Add CORS headers to response</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;headers&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cors_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                <span class="k">return</span> <span class="n">response</span>
            <span class="k">return</span> <span class="n">decorated_function</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register all API routes with security&quot;&quot;&quot;</span>

        <span class="c1"># Authentication endpoints</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/auth/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">require_cors</span><span class="p">()</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;User registration with security validation&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>  <span class="c1"># Handled by decorator</span>

            <span class="c1"># Rate limiting for registration</span>
            <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>
            <span class="n">allowed</span><span class="p">,</span> <span class="n">rate_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">sliding_window_check</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;register_</span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="mi">5</span>  <span class="c1"># 5 registrations per hour</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Registration rate limit exceeded&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;retry_after&#39;</span><span class="p">:</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;retry_after&#39;</span><span class="p">]</span>
                <span class="p">}),</span> <span class="mi">429</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid JSON data&#39;</span><span class="p">}),</span> <span class="mi">400</span>

            <span class="c1"># Input validation</span>
            <span class="n">validation_rules</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;min_length&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                    <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_]+$&#39;</span>
                <span class="p">},</span>
                <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&#39;</span>
                <span class="p">},</span>
                <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;min_length&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                    <span class="s1">&#39;validator&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span> <span class="ow">and</span> 
                                         <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span> <span class="ow">and</span> 
                                         <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_input</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">validation_rules</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Validation failed&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">errors</span><span class="p">}),</span> <span class="mi">400</span>

            <span class="c1"># Sanitize input</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_input</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check if user already exists</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id FROM users WHERE username = ? OR email = ?&#39;</span><span class="p">,</span> 
                             <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User already exists&#39;</span><span class="p">}),</span> <span class="mi">409</span>

                <span class="c1"># Generate salt and hash password</span>
                <span class="n">salt</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
                <span class="n">password_hash</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">salt</span><span class="p">)</span>

                <span class="c1"># Insert user</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    INSERT INTO users (username, email, password_hash, salt)</span>
<span class="s1">                    VALUES (?, ?, ?, ?)</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">password_hash</span><span class="p">,</span> <span class="n">salt</span><span class="p">))</span>

                <span class="n">user_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="c1"># Generate JWT token</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span>
                    <span class="n">user_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>
                    <span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;User registered successfully&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
                    <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">}),</span> <span class="mi">201</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Registration failed&#39;</span><span class="p">}),</span> <span class="mi">500</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/auth/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">require_cors</span><span class="p">()</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;User login with brute force protection&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid JSON data&#39;</span><span class="p">}),</span> <span class="mi">400</span>

            <span class="c1"># Input validation</span>
            <span class="n">validation_rules</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
                <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">}</span>
            <span class="p">}</span>

            <span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_input</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">validation_rules</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Validation failed&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">errors</span><span class="p">}),</span> <span class="mi">400</span>

            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_input</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get user with security info</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    SELECT id, username, email, password_hash, salt, </span>
<span class="s1">                           failed_login_attempts, last_failed_login, is_active</span>
<span class="s1">                    FROM users WHERE username = ?</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],))</span>

                <span class="n">user</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;is_active&#39;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid credentials&#39;</span><span class="p">}),</span> <span class="mi">401</span>

                <span class="c1"># Check for account lockout (brute force protection)</span>
                <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;failed_login_attempts&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">last_failed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;last_failed_login&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;last_failed_login&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">last_failed</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_failed</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Account temporarily locked due to failed login attempts&#39;</span>
                        <span class="p">}),</span> <span class="mi">423</span>

                <span class="c1"># Verify password</span>
                <span class="k">if</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;password_hash&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;salt&#39;</span><span class="p">]):</span>
                    <span class="c1"># Reset failed attempts on successful login</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        UPDATE users SET failed_login_attempts = 0, last_failed_login = NULL </span>
<span class="s1">                        WHERE id = ?</span>
<span class="s1">                    &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],))</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                    <span class="c1"># Generate JWT token</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span>
                        <span class="n">user_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]),</span>
                        <span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">]</span>
                    <span class="p">)</span>

                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Login successful&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
                        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">}),</span> <span class="mi">200</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Increment failed login attempts</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        UPDATE users SET </span>
<span class="s1">                            failed_login_attempts = failed_login_attempts + 1,</span>
<span class="s1">                            last_failed_login = CURRENT_TIMESTAMP</span>
<span class="s1">                        WHERE id = ?</span>
<span class="s1">                    &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],))</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid credentials&#39;</span><span class="p">}),</span> <span class="mi">401</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Login failed&#39;</span><span class="p">}),</span> <span class="mi">500</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Task management endpoints</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">require_cors</span><span class="p">()</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">require_auth</span><span class="p">([</span><span class="s1">&#39;read&#39;</span><span class="p">])</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_tasks</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get user&#39;s tasks with pagination&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>

            <span class="c1"># Get pagination parameters</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># Cap at 100</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">limit</span>

            <span class="c1"># Get filter parameters</span>
            <span class="n">status_filter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">priority_filter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Build query with filters</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    SELECT id, title, description, status, priority, created_at, updated_at</span>
<span class="s1">                    FROM tasks WHERE user_id = ?</span>
<span class="s1">                &#39;&#39;&#39;</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]]</span>

                <span class="k">if</span> <span class="n">status_filter</span><span class="p">:</span>
                    <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; AND status = ?&#39;</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">status_filter</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">priority_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; AND priority = ?&#39;</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">priority_filter</span><span class="p">)</span>

                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; ORDER BY created_at DESC LIMIT ? OFFSET ?&#39;</span>
                <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">])</span>

                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

                <span class="c1"># Get total count for pagination</span>
                <span class="n">count_query</span> <span class="o">=</span> <span class="s1">&#39;SELECT COUNT(*) FROM tasks WHERE user_id = ?&#39;</span>
                <span class="n">count_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]]</span>

                <span class="k">if</span> <span class="n">status_filter</span><span class="p">:</span>
                    <span class="n">count_query</span> <span class="o">+=</span> <span class="s1">&#39; AND status = ?&#39;</span>
                    <span class="n">count_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">status_filter</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">priority_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">count_query</span> <span class="o">+=</span> <span class="s1">&#39; AND priority = ?&#39;</span>
                    <span class="n">count_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">priority_filter</span><span class="p">)</span>

                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">count_query</span><span class="p">,</span> <span class="n">count_params</span><span class="p">)</span>
                <span class="n">total_count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">,</span>
                    <span class="s1">&#39;pagination&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
                        <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span>
                        <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">total_count</span><span class="p">,</span>
                        <span class="s1">&#39;pages&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">total_count</span> <span class="o">+</span> <span class="n">limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">limit</span>
                    <span class="p">}</span>
                <span class="p">}),</span> <span class="mi">200</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Failed to fetch tasks&#39;</span><span class="p">}),</span> <span class="mi">500</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">require_cors</span><span class="p">()</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">require_auth</span><span class="p">([</span><span class="s1">&#39;write&#39;</span><span class="p">])</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">create_task</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Create a new task&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid JSON data&#39;</span><span class="p">}),</span> <span class="mi">400</span>

            <span class="c1"># Input validation</span>
            <span class="n">validation_rules</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;min_length&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">200</span>
                <span class="p">},</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">1000</span>
                <span class="p">},</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;validator&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span> <span class="s1">&#39;in_progress&#39;</span><span class="p">,</span> <span class="s1">&#39;completed&#39;</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="s1">&#39;validator&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="mi">5</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_input</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">validation_rules</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Validation failed&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">errors</span><span class="p">}),</span> <span class="mi">400</span>

            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_input</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    INSERT INTO tasks (user_id, title, description, status, priority)</span>
<span class="s1">                    VALUES (?, ?, ?, ?, ?)</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;pending&#39;</span><span class="p">),</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">))</span>

                <span class="n">task_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="c1"># Fetch the created task</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    SELECT id, title, description, status, priority, created_at, updated_at</span>
<span class="s1">                    FROM tasks WHERE id = ?</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,))</span>

                <span class="n">task</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">())</span>

                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Task created successfully&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span>
                <span class="p">}),</span> <span class="mi">201</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Failed to create task&#39;</span><span class="p">}),</span> <span class="mi">500</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">require_cors</span><span class="p">()</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">require_auth</span><span class="p">([</span><span class="s1">&#39;write&#39;</span><span class="p">])</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">update_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Update an existing task&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid JSON data&#39;</span><span class="p">}),</span> <span class="mi">400</span>

            <span class="c1"># Input validation (same as create)</span>
            <span class="n">validation_rules</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;min_length&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">200</span>
                <span class="p">},</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">1000</span>
                <span class="p">},</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;validator&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span> <span class="s1">&#39;in_progress&#39;</span><span class="p">,</span> <span class="s1">&#39;completed&#39;</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="s1">&#39;validator&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="mi">5</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_input</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">validation_rules</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Validation failed&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">errors</span><span class="p">}),</span> <span class="mi">400</span>

            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_input</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check if task exists and belongs to user</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    SELECT id FROM tasks WHERE id = ? AND user_id = ?</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Task not found&#39;</span><span class="p">}),</span> <span class="mi">404</span>

                <span class="c1"># Build update query dynamically</span>
                <span class="n">update_fields</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">update_values</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="n">update_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> = ?&quot;</span><span class="p">)</span>
                        <span class="n">update_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">update_fields</span><span class="p">:</span>
                    <span class="n">update_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;updated_at = CURRENT_TIMESTAMP&quot;</span><span class="p">)</span>
                    <span class="n">update_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>

                    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;UPDATE tasks SET </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">update_fields</span><span class="p">)</span><span class="si">}</span><span class="s2"> WHERE id = ?&quot;</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">update_values</span><span class="p">)</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="c1"># Fetch updated task</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    SELECT id, title, description, status, priority, created_at, updated_at</span>
<span class="s1">                    FROM tasks WHERE id = ?</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,))</span>

                <span class="n">task</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">())</span>

                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Task updated successfully&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span>
                <span class="p">}),</span> <span class="mi">200</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Failed to update task&#39;</span><span class="p">}),</span> <span class="mi">500</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">require_cors</span><span class="p">()</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">require_auth</span><span class="p">([</span><span class="s1">&#39;write&#39;</span><span class="p">])</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">delete_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Delete a task&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check if task exists and belongs to user</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    SELECT id FROM tasks WHERE id = ? AND user_id = ?</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Task not found&#39;</span><span class="p">}),</span> <span class="mi">404</span>

                <span class="c1"># Delete the task</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM tasks WHERE id = ?&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,))</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Task deleted successfully&#39;</span><span class="p">}),</span> <span class="mi">200</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Failed to delete task&#39;</span><span class="p">}),</span> <span class="mi">500</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Health check endpoint</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/health&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;API health check&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0.0&#39;</span>
            <span class="p">}),</span> <span class="mi">200</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the secure API server&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Secure Task API...&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available endpoints:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;POST   /api/auth/register&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;POST   /api/auth/login&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GET    /api/tasks&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;POST   /api/tasks&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PUT    /api/tasks/&lt;id&gt;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DELETE /api/tasks/&lt;id&gt;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GET    /api/health&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">api_demonstration</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate the complete secure API&quot;&quot;&quot;</span>

    <span class="c1"># Create and configure the API</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">SecureTaskAPI</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Secure Task API initialized with:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ JWT Authentication&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Rate Limiting&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ CORS Protection&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Input Validation&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ SQL Injection Prevention&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Session Management&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Brute Force Protection&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Comprehensive Logging&quot;</span><span class="p">)</span>

    <span class="c1"># In a real application, you would call api.run()</span>
    <span class="c1"># For demonstration, we&#39;ll show the security features</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">API Security Features:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1. Authentication: JWT tokens with expiration&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2. Authorization: Permission-based access control&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3. Rate Limiting: Prevents abuse and DoS attacks&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;4. Input Validation: Comprehensive data validation&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;5. CORS: Configurable cross-origin policies&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;6. SQL Injection: Parameterized queries&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;7. XSS Prevention: Input sanitization&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;8. Brute Force: Account lockout mechanisms&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;9. Session Security: Secure session management&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;10. Error Handling: Safe error messages&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">api_demonstration</span><span class="p">()</span>
</code></pre>
</div>
<h2 id="summary-and-best-practices">Summary and Best Practices<a class="headerlink" href="#summary-and-best-practices" title="Permanent link">&para;</a></h2>
<p>This section has covered comprehensive API security through practical implementation. Here are the key takeaways:</p>
<h3 id="essential-security-principles">Essential Security Principles<a class="headerlink" href="#essential-security-principles" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>Defense in Depth</strong>: Multiple layers of security controls</p>
</li>
<li>
<p><strong>Fail Securely</strong>: Default to secure states when errors occur</p>
</li>
<li>
<p><strong>Least Privilege</strong>: Grant minimum necessary permissions</p>
</li>
<li>
<p><strong>Security by Design</strong>: Build security from the ground up</p>
</li>
</ol>
<h3 id="implementation-checklist">Implementation Checklist<a class="headerlink" href="#implementation-checklist" title="Permanent link">&para;</a></h3>
<details class="example">
<summary>Authentication Security</summary>
<h4 id="api-keys">API Keys<a class="headerlink" href="#api-keys" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Cryptographically secure generation</p>
</li>
<li>
<p>Secure storage (hash, never plain text)</p>
</li>
<li>
<p>Expiration and revocation mechanisms</p>
</li>
<li>
<p>Rate limiting integration</p>
</li>
</ul>
<h4 id="jwt-tokens">JWT Tokens<a class="headerlink" href="#jwt-tokens" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Strong secret keys</p>
</li>
<li>
<p>Token expiration policies</p>
</li>
<li>
<p>Blacklist capabilities</p>
</li>
<li>
<p>Permission-based access control</p>
</li>
</ul>
<h4 id="oauth-20">OAuth 2.0<a class="headerlink" href="#oauth-20" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Proper flow implementation</p>
</li>
<li>
<p>Scope validation</p>
</li>
<li>
<p>State parameter for CSRF protection</p>
</li>
<li>
<p>Secure token storage</p>
</li>
</ul>
</details>
<details class="example">
<summary>Rate Limiting &amp; DoS Protection</summary>
<h4 id="token-bucket-algorithm">Token Bucket Algorithm<a class="headerlink" href="#token-bucket-algorithm" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Configurable rates per identifier</p>
</li>
<li>
<p>Burst capacity management</p>
</li>
<li>
<p>Thread-safe implementation</p>
</li>
</ul>
<h4 id="progressive-penalties">Progressive Penalties<a class="headerlink" href="#progressive-penalties" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Suspicion level calculation</p>
</li>
<li>
<p>IP-based blocking</p>
</li>
<li>
<p>Pattern recognition</p>
</li>
<li>
<p>Automated responses</p>
</li>
</ul>
</details>
<details class="example">
<summary>Session Management</summary>
<h4 id="secure-session-ids">Secure Session IDs<a class="headerlink" href="#secure-session-ids" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Cryptographically random generation</p>
</li>
<li>
<p>Session rotation to prevent fixation</p>
</li>
<li>
<p>Timeout management</p>
</li>
<li>
<p>IP and user agent validation</p>
</li>
</ul>
<h4 id="security-features">Security Features<a class="headerlink" href="#security-features" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>CSRF token protection</p>
</li>
<li>
<p>Concurrent session limits</p>
</li>
<li>
<p>Suspicious activity tracking</p>
</li>
<li>
<p>Secure cookie attributes</p>
</li>
</ul>
</details>
<details class="example">
<summary>CORS Security</summary>
<h4 id="origin-validation">Origin Validation<a class="headerlink" href="#origin-validation" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Whitelist-based origin control</p>
</li>
<li>
<p>Pattern matching with security checks</p>
</li>
<li>
<p>Credential-aware policies</p>
</li>
<li>
<p>Preflight request handling</p>
</li>
</ul>
<h4 id="security-patterns">Security Patterns<a class="headerlink" href="#security-patterns" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Dangerous origin blocking</p>
</li>
<li>
<p>Method restriction</p>
</li>
<li>
<p>Header validation</p>
</li>
<li>
<p>Environment-specific policies</p>
</li>
</ul>
</details>
<details class="example">
<summary>Security Testing</summary>
<h4 id="automated-testing">Automated Testing<a class="headerlink" href="#automated-testing" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Authentication vulnerability tests</p>
</li>
<li>
<p>Injection attack simulation</p>
</li>
<li>
<p>Rate limiting verification</p>
</li>
<li>
<p>CORS policy validation</p>
</li>
</ul>
<h4 id="comprehensive-coverage">Comprehensive Coverage<a class="headerlink" href="#comprehensive-coverage" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>SQL injection with real payloads</p>
</li>
<li>
<p>XSS detection mechanisms</p>
</li>
<li>
<p>Path traversal testing</p>
</li>
<li>
<p>Security score calculation</p>
</li>
</ul>
</details>
<h3 id="production-deployment-considerations">Production Deployment Considerations<a class="headerlink" href="#production-deployment-considerations" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>HTTPS Only</strong>: Never deploy APIs without TLS encryption</p>
</li>
<li>
<p><strong>Environment Separation</strong>: Different security policies for dev/staging/production</p>
</li>
<li>
<p><strong>Monitoring</strong>: Comprehensive logging and alerting</p>
</li>
<li>
<p><strong>Updates</strong>: Regular security patches and dependency updates</p>
</li>
<li>
<p><strong>Backup</strong>: Secure data backup and recovery procedures</p>
</li>
</ol>
<h3 id="common-pitfalls-to-avoid">Common Pitfalls to Avoid<a class="headerlink" href="#common-pitfalls-to-avoid" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>Overly Permissive CORS</strong>: Never use <code>*</code> with credentials enabled</p>
</li>
<li>
<p><strong>Weak Rate Limiting</strong>: Implement multiple rate limiting strategies</p>
</li>
<li>
<p><strong>Poor Error Messages</strong>: Don&rsquo;t leak sensitive information in errors</p>
</li>
<li>
<p><strong>Insufficient Logging</strong>: Log security events for monitoring</p>
</li>
<li>
<p><strong>Hardcoded Secrets</strong>: Use environment variables for sensitive data</p>
</li>
</ul>
<p>This comprehensive implementation provides a solid foundation for building secure APIs that protect against real-world threats while maintaining usability and performance.</p>
<h2 id="practice-questions-and-exercises">Practice Questions and Exercises<a class="headerlink" href="#practice-questions-and-exercises" title="Permanent link">&para;</a></h2>
<details class="tip">
<summary>Quick Review Questions</summary>
<ol>
<li>
<p>What are the three main components of a JWT token and what information does each contain?</p>
</li>
<li>
<p>Explain the difference between symmetric and asymmetric encryption in the context of API security.</p>
</li>
<li>
<p>How does the token bucket algorithm prevent DoS attacks while allowing legitimate burst traffic?</p>
</li>
<li>
<p>What is the purpose of the <code>OPTIONS</code> method in CORS preflight requests?</p>
</li>
<li>
<p>Why should API keys be stored as hashes rather than plain text?</p>
</li>
<li>
<p>What security vulnerabilities does session rotation help prevent?</p>
</li>
<li>
<p>Explain how rate limiting can be implemented at different layers of an API architecture.</p>
</li>
<li>
<p>What is the significance of the <code>nonce</code> parameter in OAuth 2.0 flows?</p>
</li>
<li>
<p>How do CSRF tokens protect against cross-site request forgery attacks?</p>
</li>
<li>
<p>What are the key indicators that an API security testing framework should monitor?</p>
</li>
</ol>
</details>
<details class="example">
<summary>Practical Programming Exercises</summary>
<h3 id="exercise-1-secure-registration-system">Exercise 1: Secure Registration System<a class="headerlink" href="#exercise-1-secure-registration-system" title="Permanent link">&para;</a></h3>
<p>Implement a user registration system that includes:</p>
<ul>
<li>
<p>Password strength validation (minimum 8 characters, mixed case, numbers, symbols)</p>
</li>
<li>
<p>Email verification with time-limited tokens</p>
</li>
<li>
<p>Rate limiting for registration attempts</p>
</li>
<li>
<p>SQL injection prevention</p>
</li>
<li>
<p>Input sanitization for all fields</p>
</li>
</ul>
<p><strong>Requirements:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecureRegistration</span><span class="p">:</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_verification_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">verify_email_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span></code></pre></div>
<h3 id="exercise-2-api-rate-limiter">Exercise 2: API Rate Limiter<a class="headerlink" href="#exercise-2-api-rate-limiter" title="Permanent link">&para;</a></h3>
<p>Create a configurable rate limiting system with:</p>
<ul>
<li>
<p>Multiple rate limiting strategies (fixed window, sliding window, token bucket)</p>
</li>
<li>
<p>Per-user and per-IP tracking</p>
</li>
<li>
<p>Redis backend for distributed applications</p>
</li>
<li>
<p>Automatic rate limit adjustment based on server load</p>
</li>
</ul>
<p><strong>Requirements:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">AdvancedRateLimiter</span><span class="p">:</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_rate_limit_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span></code></pre></div>
<h3 id="exercise-3-cors-security-manager">Exercise 3: CORS Security Manager<a class="headerlink" href="#exercise-3-cors-security-manager" title="Permanent link">&para;</a></h3>
<p>Build a comprehensive CORS management system with:</p>
<ul>
<li>
<p>Environment-specific policies</p>
</li>
<li>
<p>Origin pattern matching with wildcards</p>
</li>
<li>
<p>Security validation for dangerous combinations</p>
</li>
<li>
<p>Real-time policy updates without service restart</p>
</li>
</ul>
<p><strong>Requirements:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">EnhancedCORSManager</span><span class="p">:</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_preflight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span>
</span></code></pre></div>
<h3 id="exercise-4-security-testing-suite">Exercise 4: Security Testing Suite<a class="headerlink" href="#exercise-4-security-testing-suite" title="Permanent link">&para;</a></h3>
<p>Develop an automated security testing framework for:</p>
<ul>
<li>
<p>Authentication bypass testing</p>
</li>
<li>
<p>Authorization escalation detection</p>
</li>
<li>
<p>Input validation verification</p>
</li>
<li>
<p>Rate limiting effectiveness</p>
</li>
<li>
<p>Session security validation</p>
</li>
</ul>
<p><strong>Requirements:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecurityTestSuite</span><span class="p">:</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_authentication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_authorization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_roles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_input_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_security_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span></code></pre></div>
</details>
<details class="warning">
<summary>Case Study Analysis</summary>
<h3 id="case-study-e-commerce-api-security-breach">Case Study: E-commerce API Security Breach<a class="headerlink" href="#case-study-e-commerce-api-security-breach" title="Permanent link">&para;</a></h3>
<p><strong>Scenario:</strong> An e-commerce platform suffered a security breach where attackers:</p>
<ol>
<li>
<p>Exploited weak API authentication to access user accounts</p>
</li>
<li>
<p>Used SQL injection to extract customer payment data</p>
</li>
<li>
<p>Performed credential stuffing attacks due to lack of rate limiting</p>
</li>
<li>
<p>Bypassed CORS protections through domain spoofing</p>
</li>
</ol>
<p><strong>Analysis Questions:</strong></p>
<ol>
<li>
<p><strong>Authentication Vulnerabilities:</strong></p>
</li>
<li>
<p>What specific authentication weaknesses likely enabled the account access?</p>
</li>
<li>
<p>How could JWT implementation flaws contribute to this breach?</p>
</li>
<li>
<p>What multi-factor authentication strategies could have prevented this?</p>
</li>
<li>
<p><strong>Injection Prevention:</strong></p>
</li>
<li>
<p>Which input validation techniques would have stopped the SQL injection?</p>
</li>
<li>
<p>How should parameterized queries be implemented in the API layer?</p>
</li>
<li>
<p>What role does output encoding play in preventing data extraction?</p>
</li>
<li>
<p><strong>Rate Limiting Failures:</strong></p>
</li>
<li>
<p>Why might traditional rate limiting have failed against credential stuffing?</p>
</li>
<li>
<p>How could progressive penalties have detected the attack pattern?</p>
</li>
<li>
<p>What rate limiting strategies work best for authentication endpoints?</p>
</li>
<li>
<p><strong>CORS Bypass Analysis:</strong></p>
</li>
<li>
<p>How do attackers typically bypass CORS protections?</p>
</li>
<li>
<p>What origin validation techniques prevent domain spoofing?</p>
</li>
<li>
<p>How should CORS policies be configured for financial applications?</p>
</li>
</ol>
<p><strong>Remediation Plan:</strong></p>
<p>Design a comprehensive security improvement plan that addresses each vulnerability type with specific technical controls and monitoring mechanisms.</p>
</details>
<h2 id="summary-checklist">Summary Checklist<a class="headerlink" href="#summary-checklist" title="Permanent link">&para;</a></h2>
<p>Use this checklist to ensure comprehensive API security implementation:</p>
<h3 id="authentication-authorization">Authentication &amp; Authorization<a class="headerlink" href="#authentication-authorization" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> Strong password policies enforced</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Multi-factor authentication implemented</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> JWT tokens with proper expiration</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> API key rotation mechanisms</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> OAuth 2.0 secure flows</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Permission-based access control</p>
</li>
</ul>
<h3 id="rate-limiting-dos-protection">Rate Limiting &amp; DoS Protection<a class="headerlink" href="#rate-limiting-dos-protection" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> Multiple rate limiting strategies</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Progressive penalty systems</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> IP-based blocking capabilities</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Burst traffic handling</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Distributed rate limiting support</p>
</li>
</ul>
<h3 id="input-validation-sanitization">Input Validation &amp; Sanitization<a class="headerlink" href="#input-validation-sanitization" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> Comprehensive validation rules</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> SQL injection prevention</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> XSS protection mechanisms</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> File upload security</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Parameter tampering protection</p>
</li>
</ul>
<h3 id="session-management">Session Management<a class="headerlink" href="#session-management" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> Secure session ID generation</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Session rotation implementation</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Timeout management</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Concurrent session limits</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> CSRF protection</p>
</li>
</ul>
<h3 id="cors-cross-origin-security">CORS &amp; Cross-Origin Security<a class="headerlink" href="#cors-cross-origin-security" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> Whitelist-based origin control</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Preflight request handling</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Credential policy management</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Environment-specific policies</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Security header implementation</p>
</li>
</ul>
<h3 id="monitoring-testing">Monitoring &amp; Testing<a class="headerlink" href="#monitoring-testing" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> Automated security testing</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Vulnerability scanning</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Security event logging</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Incident response procedures</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Regular security audits</p>
</li>
</ul>
<h3 id="deployment-security">Deployment Security<a class="headerlink" href="#deployment-security" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> HTTPS enforcement</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Secure configuration management</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Environment separation</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Secret management</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Regular updates and patches</p>
</li>
</ul>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="October 16, 2025 05:58:30 UTC">October 16, 2025</span>
  </span>

    
    
    
    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback! Help us improve this page by creating an <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/issues/new/choose" target="_blank" rel="noopener">issue</a> on github.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        

<!-- Footer -->
<footer class="md-footer">
  
    <!-- Custom footer with left/right layout -->
    <div class="md-footer__inner md-grid">
      <!-- Left side: Copyright and cookie settings -->
      <div class="md-footer__left">
        <div class="md-footer__copyright">
          
            Copyright &copy; 2025 Eatham532 – <a href="#__consent">Change cookie settings</a>

          
        </div>
      </div>

      <!-- Right side: Page name and BETA -->
      <div class="md-footer__right">
        <div class="md-footer__page-info">
          <span class="md-footer__page-title">Content</span>
          
            <span class="md-footer__beta-badge">BETA</span>
          
        </div>
      </div>
    </div>
  
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            



<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of the textbook. With your consent, you're helping us to make software engineering education better for everyone.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="github" checked>
      <span class="task-list-indicator"></span>
      GitHub
    </label>
  </li>

      
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="analytics" checked>
      <span class="task-list-indicator"></span>
      Google Analytics
    </label>
  </li>

      
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    
      
      <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "navigation.top", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.prune", "search.highlight", "search.suggest", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.action.edit", "content.action.view", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../../../assets/diagram-modal.js"></script>
      
        <script src="../../../../assets/quiz.js"></script>
      
        <script src="../../../../assets/ide-utils.js"></script>
      
        <script src="../../../../assets/code-blocks.js"></script>
      
    
  </body>
</html>